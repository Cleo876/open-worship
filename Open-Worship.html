<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWorship v3.2.0 - Modular</title>
    
    <!-- Core Configuration -->
    <script>
        // ============================================
        // OPENWORSHIP CORE CONFIGURATION
        // ============================================
        const OPENWORSHIP_CONFIG = {
            VERSION: '3.2.0',
            GITHUB_SOURCE_URL: 'https://raw.githubusercontent.com/Cleo876/open-worship/refs/heads/main/Open-Worship.html',
            DOWNLOAD_PAGE_URL: 'https://cleo876.github.io/open-worship/',
            RESOLUTION: { width: 1920, height: 1080 },
            STORAGE_KEYS: {
                PRESENTATIONS: 'openworship_presentations_v3',
                SCRIPTURE_SETTINGS: 'openworship_scripture_settings',
                FONT_SIZES: 'openworship_font_sizes',
                EXTENSIONS: 'openworship_extensions',
                SETTINGS: 'openworship_global_settings'
            }
        };
        
        // ============================================
        // MODULE REGISTRY
        // ============================================
        const OpenWorship = {
            // Core modules
            Core: null,
            UI: null,
            Data: null,
            
            // Feature modules
            Schedule: null,
            Library: null,
            Editor: null,
            Projector: null,
            FontManager: null,
            ScriptureSettings: null,
            
            // Extension system
            Extensions: {
                registry: {},
                hooks: {},
                loaded: [],
                initQueue: []
            },
            
            // Global state
            State: {
                library: [],
                bibleLibrary: [],
                schedule: [],
                currentTab: 'Song',
                availableFonts: ["Segoe UI", "Arial", "Times New Roman", "Courier New", "Poppins", "Oswald", "Open Sans"],
                scriptureSettings: {
                    font: "Segoe UI",
                    scriptureSize: 90,
                    footerSize: 40,
                    bold: false,
                    italic: false,
                    color: "#ffffff"
                },
                customFontSizes: {
                    scriptureSizes: [40, 60, 90, 120, 150, 200],
                    footerSizes: [30, 40, 50, 60],
                    editorSizes: [40, 60, 90, 120, 150, 200]
                },
                liveState: { slide: null, item: null },
                dragState: { source: null, index: -1, item: null },
                presentationsModified: false
            }
        };
        
        // ============================================
        // EXTENSION SYSTEM
        // ============================================
        class ExtensionSystem {
            constructor() {
                this.registry = {};
                this.hooks = {
                    'menu:file': [],
                    'menu:edit': [],
                    'menu:fonts': [],
                    'menu:window': [],
                    'menu:extensions': [],
                    'library:tab': [],
                    'editor:toolbar': [],
                    'preview:pane': [],
                    'schedule:item': [],
                    'projector:open': [],
                    'font:loaded': [],
                    'data:loaded': []
                };
                this.loaded = [];
                this.menuItems = [];
            }
            
            // Register an extension
            register(extension) {
                if (!extension.id || !extension.name) {
                    console.error('Extension must have id and name');
                    return false;
                }
                
                this.registry[extension.id] = {
                    ...extension,
                    enabled: true,
                    initialized: false
                };
                
                console.log(`Registered extension: ${extension.name}`);
                return true;
            }
            
            // Add a hook
            addHook(hookName, callback) {
                if (!this.hooks[hookName]) {
                    this.hooks[hookName] = [];
                }
                this.hooks[hookName].push(callback);
            }
            
            // Trigger hooks
            trigger(hookName, ...args) {
                if (!this.hooks[hookName]) return [];
                
                const results = [];
                this.hooks[hookName].forEach(callback => {
                    try {
                        results.push(callback(...args));
                    } catch (error) {
                        console.error(`Error in hook ${hookName}:`, error);
                    }
                });
                return results;
            }
            
            // Load extension from URL
            async loadExtension(url) {
                try {
                    const response = await fetch(url);
                    const script = await response.text();
                    
                    // Create a module context
                    const moduleCode = `
                        (function(OpenWorship, extension) {
                            ${script}
                        })(OpenWorship, extension);
                    `;
                    
                    // Create extension object
                    const extension = {
                        id: `external_${Date.now()}`,
                        name: url.split('/').pop().replace('.js', ''),
                        version: '1.0.0',
                        init: null
                    };
                    
                    // Execute in isolated context
                    const scriptEl = document.createElement('script');
                    scriptEl.textContent = moduleCode;
                    document.head.appendChild(scriptEl);
                    document.head.removeChild(scriptEl);
                    
                    if (extension.init && typeof extension.init === 'function') {
                        extension.init(OpenWorship);
                        extension.initialized = true;
                        this.loaded.push(extension);
                        this.trigger('extension:loaded', extension);
                        console.log(`Loaded extension: ${extension.name}`);
                    }
                    
                    return extension;
                } catch (error) {
                    console.error(`Failed to load extension from ${url}:`, error);
                    return null;
                }
            }
            
            // Load extensions from folder (simulated via File API)
            async loadExtensionsFromFolder(files) {
                const extensions = [];
                
                for (const file of files) {
                    if (file.name.endsWith('.js') || file.name.endsWith('.owx')) {
                        const content = await this.readFileAsText(file);
                        const extension = this.parseExtension(file.name, content);
                        if (extension) {
                            this.register(extension);
                            extensions.push(extension);
                        }
                    }
                }
                
                // Initialize extensions
                extensions.forEach(ext => {
                    if (ext.init && typeof ext.init === 'function') {
                        try {
                            ext.init(OpenWorship);
                            ext.initialized = true;
                            this.loaded.push(ext);
                            this.trigger('extension:loaded', ext);
                        } catch (error) {
                            console.error(`Failed to initialize extension ${ext.name}:`, error);
                        }
                    }
                });
                
                return extensions;
            }
            
            // Helper to read file as text
            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
            
            // Parse extension from content
            parseExtension(filename, content) {
                try {
                    // Look for extension metadata
                    const metadataMatch = content.match(/\/\*\*[\s\S]*?@extension[\s\S]*?\*\//);
                    let metadata = {};
                    
                    if (metadataMatch) {
                        const lines = metadataMatch[0].split('\n');
                        lines.forEach(line => {
                            if (line.includes('@name')) metadata.name = line.split('@name')[1].trim();
                            if (line.includes('@id')) metadata.id = line.split('@id')[1].trim();
                            if (line.includes('@version')) metadata.version = line.split('@version')[1].trim();
                            if (line.includes('@author')) metadata.author = line.split('@author')[1].trim();
                        });
                    }
                    
                    // Create extension object
                    const extension = {
                        id: metadata.id || `ext_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        name: metadata.name || filename.replace(/\.[^/.]+$/, ""),
                        version: metadata.version || '1.0.0',
                        author: metadata.author || 'Unknown',
                        filename: filename,
                        content: content,
                        init: null
                    };
                    
                    // Wrap the content in a function to capture init
                    const initFunction = new Function('OpenWorship', `
                        const module = {};
                        ${content}
                        if (typeof init === 'function') {
                            return init;
                        }
                        return null;
                    `);
                    
                    extension.init = initFunction(OpenWorship);
                    
                    return extension;
                } catch (error) {
                    console.error(`Error parsing extension ${filename}:`, error);
                    return null;
                }
            }
            
            // Add menu item for extensions
            addExtensionMenuItem(name, callback) {
                this.menuItems.push({ name, callback });
                this.updateExtensionsMenu();
            }
            
            // Update extensions menu - FIXED VERSION
            updateExtensionsMenu() {
                const extensionsMenu = document.querySelector('.menu-item[data-menu="extensions"]');
                if (!extensionsMenu) return;
                
                const dropdown = extensionsMenu.querySelector('.dropdown');
                if (!dropdown) return;
                
                // Clear existing extension items (keep only the initial placeholder and separator)
                const itemsToRemove = [];
                Array.from(dropdown.children).forEach((item, index) => {
                    // Keep first two items: "No extensions loaded" and separator
                    if (index >= 2) {
                        itemsToRemove.push(item);
                    }
                });
                itemsToRemove.forEach(item => item.remove());
                
                // First, add extension menu items (added via addExtensionMenuItem)
                this.menuItems.forEach(menuItem => {
                    const item = document.createElement('div');
                    item.textContent = menuItem.name;
                    item.onclick = menuItem.callback;
                    dropdown.appendChild(item);
                });
                
                // Then, add loaded extensions (if any)
                if (this.loaded.length > 0) {
                    // Add separator if we have both menu items and loaded extensions
                    if (this.menuItems.length > 0) {
                        const separator = document.createElement('div');
                        separator.className = 'separator';
                        dropdown.appendChild(separator);
                    }
                    
                    this.loaded.forEach(ext => {
                        const item = document.createElement('div');
                        item.textContent = ext.name;
                        item.onclick = () => {
                            if (ext.onClick) {
                                ext.onClick(OpenWorship);
                            }
                        };
                        dropdown.appendChild(item);
                    });
                }
                
                // Add separator if we have any items above
                if (this.menuItems.length > 0 || this.loaded.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'separator';
                    dropdown.appendChild(separator);
                }
                
                // Add "Load Extension..." item
                const loadItem = document.createElement('div');
                loadItem.textContent = 'Load Extension...';
                loadItem.onclick = () => document.getElementById('extensionInput').click();
                dropdown.appendChild(loadItem);
                
                // Add "Load Folder..." item
                const folderItem = document.createElement('div');
                folderItem.textContent = 'Load Folder...';
                folderItem.onclick = () => document.getElementById('folderInput').click();
                dropdown.appendChild(folderItem);
            }
        }
        
        // Initialize extension system
        OpenWorship.Extensions = new ExtensionSystem();
        
        // ============================================
        // CORE MODULE
        // ============================================
        class CoreModule {
            constructor() {
                this.initialized = false;
                this.modules = {};
                this.eventListeners = {};
            }
            
            async init() {
                if (this.initialized) return;
                
                console.log('Initializing OpenWorship Core...');
                
                // Initialize all core modules
                await this.initializeModules();
                
                // Load saved data
                this.loadSavedData();
                
                // Set up event listeners
                this.setupGlobalEvents();
                
                // Check for updates
                this.checkForUpdates();
                
                this.initialized = true;
                console.log('OpenWorship Core initialized');
                
                // Trigger extensions loaded event
                OpenWorship.Extensions.trigger('core:initialized');
            }
            
            async initializeModules() {
                // Initialize in order
                const moduleOrder = ['UI', 'Data', 'Schedule', 'Library', 'Editor', 'Projector', 'FontManager', 'ScriptureSettings'];
                
                for (const moduleName of moduleOrder) {
                    const moduleClass = this.getModuleClass(moduleName);
                    if (moduleClass) {
                        OpenWorship[moduleName] = new moduleClass();
                        if (OpenWorship[moduleName].init) {
                            await OpenWorship[moduleName].init();
                        }
                        this.modules[moduleName] = OpenWorship[moduleName];
                    }
                }
            }
            
            getModuleClass(name) {
                // These would be defined below
                switch(name) {
                    case 'UI': return UIModule;
                    case 'Data': return DataModule;
                    case 'Schedule': return ScheduleModule;
                    case 'Library': return LibraryModule;
                    case 'Editor': return EditorModule;
                    case 'Projector': return ProjectorModule;
                    case 'FontManager': return FontManagerModule;
                    case 'ScriptureSettings': return ScriptureSettingsModule;
                    default: return null;
                }
            }
            
            loadSavedData() {
                // Load presentations
                try {
                    const saved = localStorage.getItem(OPENWORSHIP_CONFIG.STORAGE_KEYS.PRESENTATIONS);
                    if (saved) {
                        const presentations = JSON.parse(saved);
                        OpenWorship.State.library = OpenWorship.State.library.filter(item => item.type !== 'Presentation');
                        presentations.forEach(presentation => {
                            if (!presentation.id) presentation.id = Date.now() + Math.random();
                            OpenWorship.State.library.push(presentation);
                        });
                        console.log(`Loaded ${presentations.length} presentations from storage`);
                    }
                } catch (error) {
                    console.error('Error loading presentations:', error);
                }
                
                // Load scripture settings
                try {
                    const saved = localStorage.getItem(OPENWORSHIP_CONFIG.STORAGE_KEYS.SCRIPTURE_SETTINGS);
                    if (saved) {
                        const settings = JSON.parse(saved);
                        OpenWorship.State.scriptureSettings = { ...OpenWorship.State.scriptureSettings, ...settings };
                    }
                } catch (error) {
                    console.error('Error loading scripture settings:', error);
                }
                
                // Load font sizes
                try {
                    const saved = localStorage.getItem(OPENWORSHIP_CONFIG.STORAGE_KEYS.FONT_SIZES);
                    if (saved) {
                        const sizes = JSON.parse(saved);
                        OpenWorship.State.customFontSizes = { ...OpenWorship.State.customFontSizes, ...sizes };
                    }
                } catch (error) {
                    console.error('Error loading font sizes:', error);
                }
            }
            
            setupGlobalEvents() {
                // Beforeunload handler
                window.addEventListener('beforeunload', (e) => {
                    if (OpenWorship.State.presentationsModified) {
                        const presentations = OpenWorship.State.library.filter(item => item.type === 'Presentation');
                        if (presentations.length > 0) {
                            e.preventDefault();
                            e.returnValue = 'You have unsaved presentations. Would you like to save them before leaving?';
                            OpenWorship.UI.showSavePresentationDialog();
                            return e.returnValue;
                        }
                    }
                });
                
                // Fullscreen change
                document.addEventListener('fullscreenchange', () => {
                    const btn = document.getElementById('btnFullscreen');
                    if (btn) {
                        if (document.fullscreenElement) {
                            btn.classList.add('active-state');
                        } else {
                            btn.classList.remove('active-state');
                        }
                    }
                });
            }
            
            async checkForUpdates() {
                setTimeout(async () => {
                    try {
                        const response = await fetch(OPENWORSHIP_CONFIG.GITHUB_SOURCE_URL);
                        if (!response.ok) return;
                        
                        const text = await response.text();
                        const match = text.match(/const\s+TOOL_VERSION\s+=\s+['"]([\d\.]+)['"];/);
                        
                        if (match && match[1]) {
                            const onlineVersion = match[1];
                            if (this.compareVersions(onlineVersion, OPENWORSHIP_CONFIG.VERSION) > 0) {
                                OpenWorship.UI.showUpdateBanner();
                            }
                        }
                    } catch (e) {
                        console.log("Update check skipped (offline or error).");
                    }
                }, 3000);
            }
            
            compareVersions(v1, v2) {
                const parts1 = v1.split('.').map(Number);
                const parts2 = v2.split('.').map(Number);
                for (let i = 0; i < 3; i++) {
                    if (parts1[i] > parts2[i]) return 1;
                    if (parts1[i] < parts2[i]) return -1;
                }
                return 0;
            }
            
            // Event system
            on(event, callback) {
                if (!this.eventListeners[event]) {
                    this.eventListeners[event] = [];
                }
                this.eventListeners[event].push(callback);
            }
            
            emit(event, data) {
                if (this.eventListeners[event]) {
                    this.eventListeners[event].forEach(callback => callback(data));
                }
            }
        }
        
        // ============================================
        // UI MODULE
        // ============================================
        class UIModule {
            constructor() {
                this.toast = null;
                this.updateBanner = null;
            }
            
            init() {
                this.toast = document.getElementById('toast');
                this.updateBanner = document.getElementById('updateBanner');
                
                this.setupMenu();
                this.setupVersionDisplay();
                this.setupFullscreenButton();
                
                console.log('UI Module initialized');
                return Promise.resolve();
            }
            
            setupMenu() {
                document.querySelectorAll('.menu-item').forEach(m => {
                    m.addEventListener('click', e => { 
                        e.stopPropagation(); 
                        document.querySelectorAll('.menu-item').forEach(i => i !== m && i.classList.remove('active')); 
                        m.classList.toggle('active'); 
                    });
                    m.addEventListener('mouseenter', () => { 
                        if(document.querySelector('.menu-item.active')) { 
                            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active')); 
                            m.classList.add('active'); 
                        }
                    });
                });
                document.addEventListener('click', () => { 
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active')); 
                    document.getElementById('contextMenu').style.display = 'none'; 
                });
            }
            
            setupVersionDisplay() {
                document.getElementById('version-display').textContent = 'v' + OPENWORSHIP_CONFIG.VERSION;
            }
            
            setupFullscreenButton() {
                document.getElementById('btnFullscreen').addEventListener('click', this.toggleAppFullscreen);
            }
            
            toggleAppFullscreen() {
                const body = document.documentElement;
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else if (body.requestFullscreen) {
                    body.requestFullscreen();
                } else if (body.webkitRequestFullscreen) {
                    body.webkitRequestFullscreen();
                } else if (body.msRequestFullscreen) {
                    body.msRequestFullscreen();
                }
            }
            
            showToast(message, duration = 3000) {
                const x = this.toast;
                x.innerText = message;
                x.className = "show";
                setTimeout(() => { x.className = x.className.replace("show", ""); }, duration);
            }
            
            showUpdateBanner() {
                this.updateBanner.style.display = 'block';
            }
            
            showSavePresentationDialog() {
                const presentations = OpenWorship.State.library.filter(item => item.type === 'Presentation');
                if (presentations.length > 0) {
                    document.getElementById('savePresentationDialog').style.display = 'flex';
                }
            }
            
            // Modal controls
            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }
            
            hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
        }
        
        // ============================================
        // DATA MODULE
        // ============================================
        class DataModule {
            constructor() {
                this.localFontData = {};
            }
            
            init() {
                console.log('Data Module initialized');
                return Promise.resolve();
            }
            
            savePresentationsToStorage() {
                try {
                    const presentations = OpenWorship.State.library.filter(item => item.type === 'Presentation');
                    localStorage.setItem(OPENWORSHIP_CONFIG.STORAGE_KEYS.PRESENTATIONS, JSON.stringify(presentations));
                    OpenWorship.State.presentationsModified = false;
                    console.log(`Saved ${presentations.length} presentations to storage`);
                } catch (error) {
                    console.error('Error saving presentations to storage:', error);
                    OpenWorship.UI.showToast('Error saving presentations to browser storage');
                }
            }
            
            markPresentationsModified() {
                OpenWorship.State.presentationsModified = true;
            }
            
            saveScriptureSettings() {
                try {
                    localStorage.setItem(OPENWORSHIP_CONFIG.STORAGE_KEYS.SCRIPTURE_SETTINGS, 
                        JSON.stringify(OpenWorship.State.scriptureSettings));
                    OpenWorship.UI.showToast('Scripture display settings saved!');
                    
                    // Update any live scripture display
                    if (OpenWorship.State.liveState.item && OpenWorship.State.liveState.item.type === 'Scripture') {
                        OpenWorship.Projector.reRenderLive();
                    }
                } catch (error) {
                    console.error('Error saving scripture settings:', error);
                    OpenWorship.UI.showToast('Error saving scripture settings');
                }
            }
            
            saveCustomFontSizes() {
                try {
                    localStorage.setItem(OPENWORSHIP_CONFIG.STORAGE_KEYS.FONT_SIZES, 
                        JSON.stringify(OpenWorship.State.customFontSizes));
                    OpenWorship.Editor.updateSizeDatalist();
                } catch (error) {
                    console.error('Error saving font sizes:', error);
                }
            }
            
            // File handling
            async handleContentLoad(input) {
                const file = input.files[0];
                if (!file) return;

                const fileName = file.name.toLowerCase();
                const isHymn = fileName.endsWith('.hymn');
                const isBible = fileName.endsWith('.bible');
                
                if (!isHymn && !isBible && !fileName.endsWith('.json')) {
                    OpenWorship.UI.showToast("Please select a valid .bible, .hymn, or .json file.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error("Invalid format structure");
                        
                        if (isBible) {
                            OpenWorship.State.bibleLibrary = data;
                            if (OpenWorship.State.currentTab === 'Scripture') {
                                OpenWorship.Library.render();
                            }
                            OpenWorship.UI.showToast(`Loaded ${data.length} scriptures!`);
                        } else if (isHymn || (fileName.endsWith('.json') && data.every(item => item.type === 'Song' || item.type === 'Presentation'))) {
                            const newItems = data.filter(item => item.type === 'Song' || item.type === 'Presentation');
                            OpenWorship.State.library = [...OpenWorship.State.library, ...newItems];
                            
                            if (OpenWorship.State.currentTab === 'Song' || OpenWorship.State.currentTab === 'Presentation') {
                                OpenWorship.Library.render();
                            }
                            
                            OpenWorship.UI.showToast(`Loaded ${newItems.length} songs/hymns!`);
                            
                            // If presentations were loaded, save them to storage
                            const presentationCount = newItems.filter(item => item.type === 'Presentation').length;
                            if (presentationCount > 0) {
                                this.markPresentationsModified();
                                this.savePresentationsToStorage();
                            }
                        } else {
                            OpenWorship.UI.showToast("Could not determine content type. Loaded nothing.");
                        }

                    } catch (err) {
                        OpenWorship.UI.showToast("Error reading file: " + err.message);
                    }
                };
                reader.readAsText(file);
            }
            
            // Compression
            compressImage(base64Str) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = OPENWORSHIP_CONFIG.RESOLUTION.width;
                        canvas.height = OPENWORSHIP_CONFIG.RESOLUTION.height;
                        ctx.drawImage(img, 0, 0, OPENWORSHIP_CONFIG.RESOLUTION.width, OPENWORSHIP_CONFIG.RESOLUTION.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = () => resolve(null);
                });
            }
        }
        
        // ============================================
        // SCHEDULE MODULE
        // ============================================
        class ScheduleModule {
            constructor() {
                this.currentGridSlides = [];
                this.currentSlideIdx = -1;
            }
            
            init() {
                console.log('Schedule Module initialized');
                this.render();
                return Promise.resolve();
            }
            
            render() {
                const container = document.getElementById('scheduleList');
                container.innerHTML = "";
                
                OpenWorship.State.schedule.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'schedule-item';
                    div.draggable = true;
                    div.innerHTML = `<strong>${item.title}</strong><span style="margin-left:auto; font-size:0.7em; color:#666;">${item.type}</span>`;
                    
                    div.onclick = () => this.loadToGrid(item, div);
                    div.oncontextmenu = (e) => OpenWorship.Library.showContextMenu(e, 'schedule', i, item);
                    div.ondragstart = (e) => this.startDrag(e, 'schedule', i, item);
                    div.ondragover = (e) => e.preventDefault();
                    div.ondrop = (e) => this.drop(e, i);
                    
                    container.appendChild(div);
                });
            }
            
            loadToGrid(item, element) {
                this.currentGridSlides = item.slides;
                this.currentSlideIdx = -1;
                
                document.querySelectorAll('.schedule-item').forEach(x => x.classList.remove('selected'));
                if(element) element.classList.add('selected');
                
                const grid = document.getElementById('slideGrid');
                grid.innerHTML = "";
                
                item.slides.forEach((slide, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'slide-wrapper';
                    
                    const canvas = document.createElement('canvas');
                    canvas.className = 'preview-canvas';
                    canvas.width = OPENWORSHIP_CONFIG.RESOLUTION.width;
                    canvas.height = OPENWORSHIP_CONFIG.RESOLUTION.height;
                    
                    OpenWorship.Projector.renderSlide(canvas.getContext('2d'), slide);
                    
                    wrapper.onclick = () => {
                        this.currentSlideIdx = index;
                        OpenWorship.Projector.goLive(slide, item, wrapper);
                    };
                    
                    wrapper.appendChild(canvas);
                    grid.appendChild(wrapper);
                });
            }
            
            startDrag(e, source, index, item) {
                OpenWorship.State.dragState = { source, index, item };
                e.dataTransfer.effectAllowed = (source === 'library') ? 'copy' : 'move';
                e.dataTransfer.setData('text/plain', 'valid-drag');
            }
            
            drop(e, targetIndex) {
                e.preventDefault();
                e.stopPropagation();
                
                if (targetIndex === undefined || targetIndex === null) {
                    targetIndex = OpenWorship.State.schedule.length;
                }
                
                const { source, index, item } = OpenWorship.State.dragState;
                
                if (source === 'library' && item) {
                    const clone = JSON.parse(JSON.stringify(item));
                    clone.id = Date.now();
                    OpenWorship.State.schedule.splice(targetIndex, 0, clone);
                    this.render();
                } else if (source === 'schedule') {
                    if (index !== -1) {
                        const moved = OpenWorship.State.schedule.splice(index, 1)[0];
                        OpenWorship.State.schedule.splice(targetIndex, 0, moved);
                        this.render();
                    }
                }
                
                this.resetDrag();
            }
            
            resetDrag() {
                OpenWorship.State.dragState = { source: null, index: -1, item: null };
            }
            
            async save() {
                if (OpenWorship.State.schedule.length === 0) {
                    OpenWorship.UI.showToast("Schedule is empty!");
                    return;
                }
                
                document.body.style.cursor = 'wait';
                const exportData = JSON.parse(JSON.stringify(OpenWorship.State.schedule));
                
                // Compress images
                for (const item of exportData) {
                    for (const slide of item.slides) {
                        if (slide.bgImage) {
                            const compressed = await OpenWorship.Data.compressImage(slide.bgImage);
                            if (compressed) slide.bgImage = compressed;
                        }
                    }
                }
                
                const blob = new Blob([JSON.stringify(exportData)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Service_${new Date().toISOString().slice(0, 10)}.schedule`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                document.body.style.cursor = 'default';
                OpenWorship.UI.showToast("Schedule Saved!");
            }
            
            load(input) {
                if (input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                OpenWorship.State.schedule = data;
                                this.render();
                                OpenWorship.UI.showToast("Schedule Loaded Successfully!");
                            } else {
                                OpenWorship.UI.showToast("Invalid Schedule File");
                            }
                        } catch (err) {
                            OpenWorship.UI.showToast("Error parsing schedule file.");
                        }
                    };
                    reader.readAsText(input.files[0]);
                }
            }
        }
        
        // ============================================
        // LIBRARY MODULE
        // ============================================
        class LibraryModule {
            constructor() {
                this.visibleScriptureCount = { Song: 500, Scripture: 500, Presentation: 500 };
                this.currentTabScrollPositions = { Song: 0, Scripture: 0, Presentation: 0 };
                this.isScriptureRendering = false;
                this.rightClickedItem = null;
            }
            
            init() {
                console.log('Library Module initialized');
                
                // Setup search
                document.getElementById('librarySearch').setAttribute('list', 'bibleBooks');
                
                // Setup scroll events
                ['Song', 'Scripture', 'Presentation'].forEach(tab => {
                    const list = document.getElementById(`libraryList${tab}`);
                    if (list) {
                        list.addEventListener('scroll', (e) => this.handleScroll(e));
                    }
                });
                
                return Promise.resolve();
            }
            
            switchTab(tab) {
                // Save current scroll position
                if (OpenWorship.State.currentTab) {
                    const currentList = document.getElementById(`libraryList${OpenWorship.State.currentTab}`);
                    if (currentList) {
                        this.currentTabScrollPositions[OpenWorship.State.currentTab] = currentList.scrollTop;
                    }
                }
                
                OpenWorship.State.currentTab = tab;
                
                // Hide all tab containers and show the active one
                document.querySelectorAll('.library-list-container').forEach(container => {
                    container.classList.remove('active');
                });
                document.getElementById(`${tab.toLowerCase()}ListContainer`).classList.add('active');
                
                // Restore scroll position
                setTimeout(() => {
                    const newList = document.getElementById(`libraryList${tab}`);
                    if (newList && this.currentTabScrollPositions[tab] > 0) {
                        newList.scrollTop = this.currentTabScrollPositions[tab];
                    }
                }, 10);
                
                // Update search input
                const searchInput = document.getElementById('librarySearch');
                if (tab === 'Scripture') {
                    searchInput.setAttribute('list', 'bibleBooks');
                    searchInput.placeholder = "Search Scripture (e.g. Gen 1:1)...";
                } else {
                    searchInput.removeAttribute('list');
                    searchInput.placeholder = "Search Library...";
                }
                
                searchInput.value = "";
                
                // Clear preview
                const ctx = document.getElementById('libraryPreviewCanvas').getContext('2d');
                OpenWorship.Projector.renderSlide(ctx, { layers: [{ text: "Select Item", style: { fontSize: 60 } }] });
                
                // Render appropriate content
                if (tab === 'Scripture') {
                    this.renderScriptureList('');
                } else {
                    this.render();
                }
                
                // Update tabs UI
                document.querySelectorAll('.tab').forEach(x => 
                    x.classList.toggle('active', x.innerText.includes(tab))
                );
                
                // Show/hide add button
                document.getElementById('addPresBtn').style.display = 
                    (tab === 'Presentation') ? 'flex' : 'none';
            }
            
            render(append = false) {
                if (OpenWorship.State.currentTab === 'Scripture') {
                    this.renderScriptureList('', append);
                    return;
                }
                
                // Switch preview mode
                document.getElementById('libraryPreviewCanvas').style.display = 'block';
                document.getElementById('libraryPreviewText').style.display = 'none';
                
                const container = document.getElementById(`libraryList${OpenWorship.State.currentTab}`);
                if (!append) container.innerHTML = "";
                
                const query = document.getElementById('librarySearch').value.toLowerCase();
                const filteredItems = OpenWorship.State.library.filter(x => 
                    x.type === OpenWorship.State.currentTab && 
                    x.title.toLowerCase().includes(query)
                );
                
                filteredItems.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'schedule-item';
                    div.innerText = item.title;
                    div.draggable = true;
                    div.setAttribute('data-id', item.id);
                    
                    div.onclick = () => {
                        const ctx = document.getElementById('libraryPreviewCanvas').getContext('2d');
                        const firstSlide = item.slides[0] || { text: "", layers: [] };
                        OpenWorship.Projector.renderSlide(ctx, firstSlide, "Preview");
                    };
                    
                    div.ondblclick = () => OpenWorship.Projector.goLive(item.slides[0], item);
                    div.oncontextmenu = (e) => this.showContextMenu(e, 'library', OpenWorship.State.library.indexOf(item), item);
                    div.ondragstart = (e) => OpenWorship.Schedule.startDrag(e, 'library', i, item);
                    
                    container.appendChild(div);
                });
                
                if (filteredItems.length === 0 && !append) {
                    container.innerHTML = `<div style='padding:20px; color:#777;'>No ${OpenWorship.State.currentTab.toLowerCase()}s found.</div>`;
                }
                
                // Restore scroll position
                if (this.currentTabScrollPositions[OpenWorship.State.currentTab] > 0 && !append) {
                    setTimeout(() => {
                        container.scrollTop = this.currentTabScrollPositions[OpenWorship.State.currentTab];
                    }, 10);
                }
            }
            
            renderScriptureList(query, append = false) {
                const container = document.getElementById('libraryListScripture');
                
                // Switch preview mode
                document.getElementById('libraryPreviewCanvas').style.display = 'none';
                document.getElementById('libraryPreviewText').style.display = 'block';
                
                if (!append) {
                    container.innerHTML = "";
                    this.visibleScriptureCount.Scripture = 500;
                }
                
                const rangeRegex = /^([1-3]?\s?[a-zA-Z]+)\s+(\d+):(\d+)-(\d+)$/;
                const match = query.match(rangeRegex);
                
                // Handle range item
                if (match) {
                    const book = match[1];
                    const chapter = parseInt(match[2]);
                    const startV = parseInt(match[3]);
                    const endV = parseInt(match[4]);
                    
                    const verses = OpenWorship.State.bibleLibrary.filter(v => 
                        v.title.startsWith(`${book} ${chapter}:`)
                    ).filter(v => {
                        const vNum = parseInt(v.title.split(':')[1]);
                        return vNum >= startV && vNum <= endV;
                    });
                    
                    if (verses.length > 0) {
                        const compositeItem = {
                            id: Date.now(),
                            title: `${book} ${chapter}:${startV}-${endV} (Range)`,
                            type: 'Scripture',
                            slides: verses.map(v => {
                                const slide = JSON.parse(JSON.stringify(v.slides[0]));
                                slide.verseReference = v.title;
                                return slide;
                            })
                        };
                        
                        const div = document.createElement('div');
                        div.className = 'schedule-item range-item';
                        div.innerHTML = `<span>${compositeItem.title}</span>`;
                        div.draggable = true;
                        div.ondragstart = (e) => OpenWorship.Schedule.startDrag(e, 'library', -1, compositeItem);
                        
                        div.onclick = () => {
                            const content = compositeItem.slides.map(s => 
                                `${s.verseReference}\n${s.layers[0].text}`
                            ).join('\n\n---\n\n');
                            document.getElementById('libraryPreviewText').innerText = content;
                        };
                        
                        div.ondblclick = () => OpenWorship.Projector.goLive(compositeItem.slides[0], compositeItem);
                        container.appendChild(div);
                        
                        if (!append) return;
                    }
                }
                
                // Handle regular search
                const lowerQ = query.toLowerCase();
                const itemsToRender = OpenWorship.State.bibleLibrary.filter(item => 
                    item.title.toLowerCase().includes(lowerQ)
                );
                
                const existingItems = container.querySelectorAll('.schedule-item:not(.range-item)').length;
                const startIndex = append ? existingItems : 0;
                const endIndex = Math.min(this.visibleScriptureCount.Scripture, itemsToRender.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const item = itemsToRender[i];
                    
                    // Skip if already exists
                    if (container.querySelector(`[data-id="${item.id}"]`)) continue;
                    
                    const div = document.createElement('div');
                    div.className = 'schedule-item';
                    div.innerText = item.title;
                    div.draggable = true;
                    div.setAttribute('data-id', item.id);
                    
                    div.onclick = () => {
                        const content = `${item.title}\n\n${item.slides[0].layers[0].text}`;
                        document.getElementById('libraryPreviewText').innerText = content;
                    };
                    
                    div.ondblclick = () => OpenWorship.Projector.goLive(item.slides[0], item);
                    div.ondragstart = (e) => OpenWorship.Schedule.startDrag(e, 'library', -1, item);
                    
                    container.appendChild(div);
                }
                
                if (itemsToRender.length === 0 && !append && !match) {
                    container.innerHTML = "<div style='padding:20px; color:#777;'>" +
                        (OpenWorship.State.bibleLibrary.length === 0 ?
                            "Bible not loaded. Go to File > Fetch Bible." :
                            "No matching scriptures found.") +
                        "</div>";
                }
                
                // Update preview text
                if (!append && container.querySelectorAll('.schedule-item').length > 0) {
                    const firstItem = container.querySelector('.schedule-item');
                    if (firstItem) firstItem.click();
                } else if (container.querySelectorAll('.schedule-item').length === 0 && !match) {
                    document.getElementById('libraryPreviewText').innerText = "Select an item to preview text...";
                }
                
                // Restore scroll position
                if (this.currentTabScrollPositions.Scripture > 0 && !append) {
                    setTimeout(() => {
                        container.scrollTop = this.currentTabScrollPositions.Scripture;
                    }, 10);
                }
            }
            
            handleScroll(e) {
                const container = e.target;
                const containerId = container.id;
                
                // Save scroll position
                if (containerId === 'libraryListSong') {
                    this.currentTabScrollPositions.Song = container.scrollTop;
                } else if (containerId === 'libraryListScripture') {
                    this.currentTabScrollPositions.Scripture = container.scrollTop;
                    this.handleScriptureScroll(container);
                } else if (containerId === 'libraryListPresentation') {
                    this.currentTabScrollPositions.Presentation = container.scrollTop;
                }
            }
            
            handleScriptureScroll(container) {
                if (OpenWorship.State.currentTab !== 'Scripture') return;
                if (this.isScriptureRendering) return;
                
                const scrollThreshold = 100;
                const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight <= scrollThreshold;
                
                if (isNearBottom) {
                    const query = document.getElementById('librarySearch').value;
                    const lowerQ = query.toLowerCase();
                    const filtered = OpenWorship.State.bibleLibrary.filter(item => 
                        item.title.toLowerCase().includes(lowerQ)
                    );
                    
                    if (this.visibleScriptureCount.Scripture < filtered.length) {
                        this.isScriptureRendering = true;
                        this.visibleScriptureCount.Scripture += 500;
                        
                        setTimeout(() => {
                            this.renderScriptureList(query, true);
                            this.isScriptureRendering = false;
                        }, 50);
                    }
                }
            }
            
            handleSearch() {
                const query = document.getElementById('librarySearch').value;
                
                // Reset scroll count for new searches
                const rangeRegex = /^([1-3]?\s?[a-zA-Z]+)\s+(\d+):(\d+)-(\d+)$/;
                const match = query.match(rangeRegex);
                
                if (!match) {
                    this.visibleScriptureCount.Scripture = 500;
                }
                
                if (OpenWorship.State.currentTab === 'Scripture') {
                    this.renderScriptureList(query, false);
                } else if (OpenWorship.State.currentTab === 'Song') {
                    this.visibleScriptureCount.Song = 500;
                    this.render(false);
                } else if (OpenWorship.State.currentTab === 'Presentation') {
                    this.visibleScriptureCount.Presentation = 500;
                    this.render(false);
                }
            }
            
            showContextMenu(e, context, index, item) {
                e.preventDefault();
                this.rightClickedItem = { context, index, item };
                
                const menu = document.getElementById('contextMenu');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                
                const removeBtn = document.getElementById('ctxRemove');
                const renameBtn = document.getElementById('ctxRename');
                
                if (context === 'schedule') {
                    removeBtn.style.display = 'block';
                } else if (context === 'library' && item.type === 'Presentation') {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
                
                renameBtn.style.display = 'block';
                renameBtn.onclick = () => {
                    menu.style.display = 'none';
                    const sourceArray = (context === 'schedule') ? OpenWorship.State.schedule : OpenWorship.State.library;
                    const sourceIndex = sourceArray.findIndex(i => i.id === item.id);
                    if (sourceIndex !== -1) {
                        OpenWorship.Editor.open(sourceIndex, context);
                    }
                };
            }
            
            removeItem() {
                const { context, index, item } = this.rightClickedItem;
                
                if (context === 'schedule') {
                    OpenWorship.State.schedule.splice(index, 1);
                    OpenWorship.Schedule.render();
                } else if (context === 'library') {
                    // If removing a presentation, mark as modified
                    if (item.type === 'Presentation') {
                        OpenWorship.Data.markPresentationsModified();
                    }
                    
                    OpenWorship.State.library.splice(index, 1);
                    this.render();
                    
                    // Save presentations to storage if one was removed
                    if (item.type === 'Presentation') {
                        OpenWorship.Data.savePresentationsToStorage();
                    }
                }
                
                document.getElementById('contextMenu').style.display = 'none';
            }
        }
        
        // ============================================
        // EDITOR MODULE
        // ============================================
        class EditorModule {
            constructor() {
                this.editingItem = null;
                this.tempSlides = [];
                this.currentSlideIndex = 0;
                this.selectedLayerIndex = 0;
                this.isDragging = false;
                this.lastMouseX = 0;
                this.lastMouseY = 0;
            }
            
            init() {
                console.log('Editor Module initialized');
                this.setupInteraction();
                return Promise.resolve();
            }
            
            setupInteraction() {
                const canvas = document.getElementById('editorCanvas');
                
                canvas.addEventListener('mousedown', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = OPENWORSHIP_CONFIG.RESOLUTION.width / rect.width;
                    const scaleY = OPENWORSHIP_CONFIG.RESOLUTION.height / rect.height;
                    const mouseX = (e.clientX - rect.left) * scaleX;
                    const mouseY = (e.clientY - rect.top) * scaleY;
                    
                    let clickedLayer = -1;
                    let minDist = 1000;
                    const slide = this.tempSlides[this.currentSlideIndex];
                    
                    slide.layers.forEach((layer, idx) => {
                        const lx = (OPENWORSHIP_CONFIG.RESOLUTION.width / 2) + (parseInt(layer.style?.x) || 0);
                        const ly = (OPENWORSHIP_CONFIG.RESOLUTION.height / 2) + (parseInt(layer.style?.y) || 0);
                        const dist = Math.sqrt(Math.pow(mouseX - lx, 2) + Math.pow(mouseY - ly, 2));
                        
                        if (dist < 400 && dist < minDist) {
                            minDist = dist;
                            clickedLayer = idx;
                        }
                    });
                    
                    if (clickedLayer !== -1) {
                        this.selectedLayerIndex = clickedLayer;
                        this.loadLayerToToolbar();
                        this.isDragging = true;
                        this.lastMouseX = e.offsetX;
                        this.lastMouseY = e.offsetY;
                        canvas.style.cursor = 'grabbing';
                    }
                });
                
                window.addEventListener('mousemove', (e) => {
                    if (!this.isDragging) return;
                    
                    const canvas = document.getElementById('editorCanvas');
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = OPENWORSHIP_CONFIG.RESOLUTION.width / rect.width;
                    const scaleY = OPENWORSHIP_CONFIG.RESOLUTION.height / rect.height;
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    const dx = (mouseX - this.lastMouseX) * scaleX;
                    const dy = (mouseY - this.lastMouseY) * scaleY;
                    
                    const slide = this.tempSlides[this.currentSlideIndex];
                    const layer = slide.layers[this.selectedLayerIndex];
                    if (!layer.style) layer.style = {};
                    
                    layer.style.x = (parseInt(layer.style.x) || 0) + dx;
                    layer.style.y = (parseInt(layer.style.y) || 0) + dy;
                    
                    this.lastMouseX = mouseX;
                    this.lastMouseY = mouseY;
                    this.renderPreview();
                });
                
                window.addEventListener('mouseup', () => {
                    if (this.isDragging) {
                        this.isDragging = false;
                        const canvas = document.getElementById('editorCanvas');
                        canvas.style.cursor = 'default';
                    }
                });
            }
            
            open(itemIndex, context) {
                const source = context === 'schedule' ? OpenWorship.State.schedule : OpenWorship.State.library;
                const item = source[itemIndex];
                
                this.editingItem = { context, index: itemIndex, ref: item };
                this.tempSlides = item.slides.map(s => {
                    const slide = JSON.parse(JSON.stringify(s));
                    if (slide.text) {
                        slide.layers = [{ text: slide.text, style: slide.style || {} }];
                        delete slide.text;
                        delete slide.style;
                    }
                    if (!slide.layers) slide.layers = [];
                    if (slide.layers.length === 0) slide.layers.push({ text: "New Text", style: {} });
                    return slide;
                });
                
                this.currentSlideIndex = 0;
                this.selectedLayerIndex = 0;
                
                // Load title
                document.getElementById('editItemTitle').value = item.title;
                
                // Load fonts
                const select = document.getElementById('toolFont');
                select.innerHTML = '';
                OpenWorship.State.availableFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    select.appendChild(option);
                });
                
                // Show modal
                document.getElementById('editorModal').style.display = 'flex';
                this.renderSlideList();
                this.loadSlide(0);
            }
            
            renderSlideList() {
                const list = document.getElementById('editorSlideList');
                list.innerHTML = '';
                
                this.tempSlides.forEach((slide, i) => {
                    const div = document.createElement('div');
                    div.className = `slide-thumb ${i === this.currentSlideIndex ? 'active' : ''}`;
                    const text = slide.layers[0]?.text || "Empty";
                    div.innerHTML = `<span class="thumb-num">${i + 1}</span> <span style="font-size:0.8rem; overflow:hidden; white-space:nowrap;">${text.substring(0, 12)}...</span>`;
                    div.onclick = () => this.loadSlide(i);
                    list.appendChild(div);
                });
            }
            
            loadSlide(index) {
                this.currentSlideIndex = index;
                this.selectedLayerIndex = 0;
                this.renderSlideList();
                this.loadLayerToToolbar();
                this.renderPreview();
            }
            
            loadLayerToToolbar() {
                const slide = this.tempSlides[this.currentSlideIndex];
                const textarea = document.getElementById('editorTextArea');
                
                if (slide.layers.length === 0) {
                    textarea.value = "";
                    textarea.disabled = true;
                    return;
                }
                
                textarea.disabled = false;
                if (this.selectedLayerIndex >= slide.layers.length) {
                    this.selectedLayerIndex = 0;
                }
                
                const layer = slide.layers[this.selectedLayerIndex];
                if (!layer.style) layer.style = {};
                
                document.getElementById('toolFont').value = layer.style.font || "Segoe UI";
                document.getElementById('toolSize').value = layer.style.fontSize || 90;
                document.getElementById('toolColor').value = layer.style.color || "#ffffff";
                textarea.value = layer.text;
                textarea.focus();
            }
            
            addTextBlock() {
                this.tempSlides[this.currentSlideIndex].layers.push({
                    text: "New Block",
                    style: { fontSize: 60, y: 100 }
                });
                
                this.selectedLayerIndex = this.tempSlides[this.currentSlideIndex].layers.length - 1;
                this.loadLayerToToolbar();
                this.renderPreview();
            }
            
            removeCurrentBlock() {
                const slide = this.tempSlides[this.currentSlideIndex];
                if (slide.layers.length <= 1) {
                    alert("Slide must have at least one block.");
                    return;
                }
                
                slide.layers.splice(this.selectedLayerIndex, 1);
                this.selectedLayerIndex = 0;
                this.loadLayerToToolbar();
                this.renderPreview();
            }
            
            updateCurrentBlockText() {
                this.tempSlides[this.currentSlideIndex].layers[this.selectedLayerIndex].text = 
                    document.getElementById('editorTextArea').value;
                this.renderSlideList();
                this.renderPreview();
            }
            
            updateCurrentBlockStyle() {
                const layer = this.tempSlides[this.currentSlideIndex].layers[this.selectedLayerIndex];
                if (!layer.style) layer.style = {};
                
                layer.style.font = document.getElementById('toolFont').value;
                const newSize = parseInt(document.getElementById('toolSize').value);
                layer.style.fontSize = newSize;
                layer.style.color = document.getElementById('toolColor').value;
                
                // Save this size to custom sizes
                this.addEditorSize(newSize);
                
                this.renderPreview();
            }
            
            toggleStyle(prop) {
                const layer = this.tempSlides[this.currentSlideIndex].layers[this.selectedLayerIndex];
                if (!layer.style) layer.style = {};
                layer.style[prop] = !layer.style[prop];
                this.renderPreview();
            }
            
            renderPreview() {
                const canvas = document.getElementById('editorCanvas');
                const ctx = canvas.getContext('2d');
                OpenWorship.Projector.renderSlide(ctx, this.tempSlides[this.currentSlideIndex]);
            }
            
            addNewSlide() {
                this.tempSlides.push({
                    layers: [{ text: "New Slide", style: {} }]
                });
                this.loadSlide(this.tempSlides.length - 1);
            }
            
            saveChanges() {
                const newTitle = document.getElementById('editItemTitle').value.trim();
                if (newTitle) {
                    this.editingItem.ref.title = newTitle;
                }
                
                this.editingItem.ref.slides = this.tempSlides;
                
                if (this.editingItem.context === 'schedule') {
                    OpenWorship.Schedule.render();
                } else {
                    OpenWorship.Library.render();
                }
                
                document.getElementById('editorModal').style.display = 'none';
                OpenWorship.UI.showToast(`Item "${this.editingItem.ref.title}" updated.`);
                
                // If this was a presentation, mark as modified and save to storage
                if (this.editingItem.ref.type === 'Presentation') {
                    OpenWorship.Data.markPresentationsModified();
                    OpenWorship.Data.savePresentationsToStorage();
                }
            }
            
            close() {
                document.getElementById('editorModal').style.display = 'none';
            }
            
            uploadSlideBG(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.tempSlides[this.currentSlideIndex].bgImage = e.target.result;
                        this.renderPreview();
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
            
            clearSlideBG() {
                delete this.tempSlides[this.currentSlideIndex].bgImage;
                this.renderPreview();
            }
            
            createNewPresentation() {
                const newItem = {
                    id: Date.now(),
                    title: "New Presentation",
                    type: "Presentation",
                    slides: [{ layers: [{ text: "Title Slide", style: { fontSize: 90 } }] }]
                };
                
                OpenWorship.State.library.push(newItem);
                OpenWorship.Library.render();
                OpenWorship.Data.markPresentationsModified();
                OpenWorship.Data.savePresentationsToStorage();
                this.open(OpenWorship.State.library.length - 1, 'library');
            }
            
            addEditorSize(size) {
                if (size && !OpenWorship.State.customFontSizes.editorSizes.includes(size)) {
                    OpenWorship.State.customFontSizes.editorSizes.push(size);
                    OpenWorship.State.customFontSizes.editorSizes.sort((a, b) => a - b);
                    OpenWorship.Data.saveCustomFontSizes();
                }
            }
            
            updateSizeDatalist() {
                const datalist = document.getElementById('sizePresets');
                datalist.innerHTML = '';
                
                // Add default sizes
                [40, 60, 90, 120, 150, 200].forEach(size => {
                    if (!OpenWorship.State.customFontSizes.editorSizes.includes(size)) {
                        OpenWorship.State.customFontSizes.editorSizes.push(size);
                    }
                });
                
                // Sort and add to datalist
                OpenWorship.State.customFontSizes.editorSizes.sort((a, b) => a - b);
                OpenWorship.State.customFontSizes.editorSizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size;
                    datalist.appendChild(option);
                });
            }
        }
        
        // ============================================
        // PROJECTOR MODULE
        // ============================================
        class ProjectorModule {
            constructor() {
                this.projectorWindow = null;
                this.logoImage = null;
                this.isBlack = false;
                this.isClear = false;
                this.isLogo = false;
            }
            
            init() {
                console.log('Projector Module initialized');
                this.setupKeyboardNav();
                return Promise.resolve();
            }
            
            setupKeyboardNav() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    const currentGridSlides = OpenWorship.Schedule.currentGridSlides;
                    const currentSlideIdx = OpenWorship.Schedule.currentSlideIdx;
                    
                    if (currentGridSlides.length > 0) {
                        if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            if (currentSlideIdx < currentGridSlides.length - 1) {
                                const wrappers = document.querySelectorAll('#slideGrid .slide-wrapper');
                                const nextIdx = currentSlideIdx + 1;
                                if (wrappers[nextIdx]) wrappers[nextIdx].click();
                            }
                        } else if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            if (currentSlideIdx > 0) {
                                const wrappers = document.querySelectorAll('#slideGrid .slide-wrapper');
                                const prevIdx = currentSlideIdx - 1;
                                if (wrappers[prevIdx]) wrappers[prevIdx].click();
                            }
                        }
                    }
                });
            }
            
            renderSlide(ctx, slideObj, footer = "") {
                if (!slideObj) slideObj = { layers: [] };
                
                // Handle legacy format
                if (slideObj.text) {
                    slideObj.layers = [{ text: slideObj.text, style: slideObj.style || {} }];
                    delete slideObj.text;
                    delete slideObj.style;
                }
                
                if (!slideObj.layers) slideObj.layers = [];
                
                // Clear canvas
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, OPENWORSHIP_CONFIG.RESOLUTION.width, OPENWORSHIP_CONFIG.RESOLUTION.height);
                
                const isPreview = ctx.canvas.id.includes('editor') || ctx.canvas.id.includes('library');
                
                if (!isPreview) {
                    // Handle logo
                    if (this.isLogo && this.logoImage) {
                        const scale = Math.min(
                            OPENWORSHIP_CONFIG.RESOLUTION.width / this.logoImage.width,
                            OPENWORSHIP_CONFIG.RESOLUTION.height / this.logoImage.height
                        );
                        const w = this.logoImage.width * scale;
                        const h = this.logoImage.height * scale;
                        ctx.drawImage(this.logoImage,
                            (OPENWORSHIP_CONFIG.RESOLUTION.width - w) / 2,
                            (OPENWORSHIP_CONFIG.RESOLUTION.height - h) / 2,
                            w, h
                        );
                        return;
                    }
                    
                    // Handle black screen
                    if (this.isBlack) return;
                }
                
                // Draw background image
                if (slideObj.bgImage && !this.isClear) {
                    if (!slideObj._bgImgObj || slideObj._bgImgObj.src !== slideObj.bgImage) {
                        slideObj._bgImgObj = new Image();
                        slideObj._bgImgObj.src = slideObj.bgImage;
                        slideObj._bgImgObj.onload = () => {
                            if (ctx.canvas.id.includes('editor')) {
                                OpenWorship.Editor.renderPreview();
                            }
                        };
                    }
                    
                    if (slideObj._bgImgObj.complete) {
                        ctx.drawImage(slideObj._bgImgObj, 0, 0,
                            OPENWORSHIP_CONFIG.RESOLUTION.width,
                            OPENWORSHIP_CONFIG.RESOLUTION.height
                        );
                    }
                }
                
                if (this.isClear && !isPreview) return;
                
                // Draw layers
                slideObj.layers.forEach((layer, idx) => {
                    const style = layer.style || {};
                    const text = layer.text || "";
                    
                    // Highlight selected layer in editor
                    if (ctx.canvas.id.includes('editor') && idx === OpenWorship.Editor.selectedLayerIndex) {
                        ctx.save();
                        ctx.strokeStyle = '#007acc';
                        ctx.lineWidth = 2;
                        ctx.restore();
                    }
                    
                    const fontSize = parseInt(style.fontSize) || 90;
                    const fontFace = style.font || "Segoe UI";
                    const fontWeight = style.bold ? "bold" : "normal";
                    const fontStyle = style.italic ? "italic" : "normal";
                    const color = style.color || "white";
                    const offX = parseInt(style.x || 0);
                    const offY = parseInt(style.y || 0);
                    
                    ctx.font = `${fontStyle} ${fontWeight} ${fontSize}px "${fontFace}"`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.lineJoin = "round";
                    ctx.miterLimit = 2;
                    
                    // Text shadow
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 4;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                    
                    // Word wrap
                    const maxWidth = OPENWORSHIP_CONFIG.RESOLUTION.width - 200;
                    const words = text.split('\n').join(' [BR] ').split(' ');
                    let lines = [];
                    let currentLine = words[0];
                    
                    for (let i = 1; i < words.length; i++) {
                        if (words[i] === '[BR]') {
                            lines.push(currentLine);
                            currentLine = "";
                            continue;
                        }
                        
                        const testLine = currentLine + (currentLine === "" ? "" : " ") + words[i];
                        const metrics = ctx.measureText(testLine);
                        
                        if (metrics.width < maxWidth) {
                            currentLine = testLine;
                        } else {
                            lines.push(currentLine);
                            currentLine = words[i];
                        }
                    }
                    lines.push(currentLine);
                    
                    // Positioning
                    const lineHeight = fontSize * 1.2;
                    const startY = (OPENWORSHIP_CONFIG.RESOLUTION.height - (lines.length * lineHeight)) / 2 + (lineHeight / 2);
                    const centerX = (OPENWORSHIP_CONFIG.RESOLUTION.width / 2) + offX;
                    let drawY = startY + offY;
                    
                    // Draw each line
                    lines.forEach(line => {
                        if (line) {
                            // Outline
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = fontSize * 0.04;
                            ctx.strokeText(line, centerX, drawY);
                            
                            // Fill
                            ctx.fillStyle = color;
                            ctx.fillText(line, centerX, drawY);
                            
                            drawY += lineHeight;
                        }
                    });
                });
                
                // Draw footer
                if (footer && !isPreview) {
                    const footerSize = footer.includes("(KJV)") ?
                        OpenWorship.State.scriptureSettings.footerSize : 40;
                    
                    ctx.font = `bold ${footerSize}px Arial`;
                    ctx.textAlign = 'right';
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.shadowBlur = 0;
                    ctx.fillText(footer,
                        OPENWORSHIP_CONFIG.RESOLUTION.width - 50,
                        OPENWORSHIP_CONFIG.RESOLUTION.height - 50
                    );
                }
            }
            
            transitionLiveState(newSlide, newItem, footer) {
                const monitor = document.getElementById('monitorCanvas');
                let pCanvas = null;
                
                if (this.projectorWindow && !this.projectorWindow.closed) {
                    pCanvas = this.projectorWindow.document.getElementById('projectorCanvas');
                }
                
                // Add fading class
                monitor.classList.add('fading');
                if (pCanvas) pCanvas.classList.add('fading');
                
                setTimeout(() => {
                    // Apply scripture settings if this is a scripture
                    if (newItem && newItem.type === 'Scripture' && newSlide) {
                        const settings = OpenWorship.State.scriptureSettings;
                        if (newSlide.layers && newSlide.layers.length > 0) {
                            newSlide.layers[0].style = {
                                ...newSlide.layers[0].style,
                                font: settings.font,
                                fontSize: settings.scriptureSize,
                                color: settings.color,
                                bold: settings.bold,
                                italic: settings.italic
                            };
                        }
                    }
                    
                    // Render on monitor
                    this.renderSlide(monitor.getContext('2d'), newSlide, footer);
                    
                    // Render on projector if open
                    if (pCanvas) {
                        this.renderSlide(pCanvas.getContext('2d'), newSlide, footer);
                        pCanvas.classList.remove('fading');
                    }
                    
                    monitor.classList.remove('fading');
                    
                    // Update live state
                    OpenWorship.State.liveState.slide = newSlide;
                    OpenWorship.State.liveState.item = newItem;
                }, 300);
            }
            
            goLive(slide, item, element) {
                document.querySelectorAll('.slide-wrapper').forEach(x => x.classList.remove('active'));
                if (element) element.classList.add('active');
                
                let footer = "";
                if (slide && slide.verseReference) {
                    footer = `- ${slide.verseReference} (KJV)`;
                } else if (item && item.type === 'Scripture') {
                    footer = `- ${item.title} (KJV)`;
                }
                
                this.transitionLiveState(slide, item, footer);
            }
            
            reRenderLive() {
                const active = document.querySelector('.slide-wrapper.active');
                if (active) {
                    active.click();
                } else {
                    let footer = "";
                    const liveState = OpenWorship.State.liveState;
                    
                    if (liveState.slide && liveState.slide.verseReference) {
                        footer = `- ${liveState.slide.verseReference} (KJV)`;
                    } else if (liveState.item && liveState.item.type === 'Scripture') {
                        footer = `- ${liveState.item.title} (KJV)`;
                    }
                    
                    this.transitionLiveState(liveState.slide, liveState.item, footer);
                }
            }
            
            toggleBlack() {
                this.isBlack = !this.isBlack;
                document.getElementById('btnBlack').classList.toggle('active-state');
                this.reRenderLive();
            }
            
            toggleClear() {
                this.isClear = !this.isClear;
                document.getElementById('btnClear').classList.toggle('active-state');
                this.reRenderLive();
            }
            
            toggleLogo() {
                this.isLogo = !this.isLogo;
                document.getElementById('btnLogo').classList.toggle('active-state');
                this.reRenderLive();
            }
            
            handleLogoUpload(input) {
                if (input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.logoImage = new Image();
                        this.logoImage.src = e.target.result;
                        OpenWorship.UI.showToast("Logo Set Successfully");
                        if (this.isLogo) this.reRenderLive();
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
            
            openProjector() {
                if (this.projectorWindow && !this.projectorWindow.closed) {
                    this.projectorWindow.focus();
                    return;
                }
                
                // Collect font data for synchronization
                let fontStyles = '';
                for (const fontName in OpenWorship.Data.localFontData) {
                    fontStyles += `@font-face { font-family: "${fontName}"; src: url(${OpenWorship.Data.localFontData[fontName]}); }\n`;
                }
                
                const googleFontsLink = 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Poppins:wght@400;700&display=swap';
                
                // Create projector window
                this.projectorWindow = window.open("", "Projector", "width=800,height=600");
                
                this.projectorWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>LIVE OUTPUT</title>
                        <link href="${googleFontsLink}" rel="stylesheet">
                        <style>
                            body { margin:0; background:black; overflow:hidden; }
                            canvas { width:100vw; height:100vh; object-fit:contain; display:block; transition: opacity 0.3s ease; }
                            .fading { opacity: 0; }
                            ${fontStyles}
                        </style>
                    </head>
                    <body>
                        <canvas id="projectorCanvas" 
                                width="${OPENWORSHIP_CONFIG.RESOLUTION.width}" 
                                height="${OPENWORSHIP_CONFIG.RESOLUTION.height}"></canvas>
                        <script>
                            // Font synchronization
                            function synchronizeFonts() {
                                try {
                                    if (window.opener && !window.opener.closed) {
                                        const localFontData = window.opener.OpenWorship?.Data?.localFontData || {};
                                        for (let fontName in localFontData) {
                                            try {
                                                const fontFace = new FontFace(fontName, \`url(\${localFontData[fontName]})\`);
                                                document.fonts.add(fontFace);
                                            } catch(e) {
                                                console.log("Failed to load font:", fontName);
                                            }
                                        }
                                    }
                                } catch(e) {
                                    console.log("Font sync error:", e);
                                }
                            }
                            
                            window.addEventListener('load', synchronizeFonts);
                            
                            document.addEventListener('dblclick', () => {
                                if (!document.fullscreenElement) {
                                    document.documentElement.requestFullscreen();
                                } else {
                                    document.exitFullscreen();
                                }
                            });
                            
                            document.addEventListener('click', (e) => e.preventDefault());
                        <\/script>
                    </body>
                    </html>
                `);
                
                // Wait for window to load
                this.projectorWindow.onload = () => {
                    document.getElementById('projStatus').innerText = "LIVE";
                    document.getElementById('projStatus').style.color = "#4caf50";
                    
                    // Force re-render
                    setTimeout(() => {
                        this.reRenderLive();
                        
                        // Additional font sync
                        if (this.projectorWindow) {
                            try {
                                this.projectorWindow.synchronizeFonts();
                            } catch (e) {
                                console.log("Projector font sync:", e);
                            }
                        }
                    }, 500);
                };
                
                // Monitor window closure
                const timer = setInterval(() => {
                    if (this.projectorWindow.closed) {
                        clearInterval(timer);
                        const status = document.getElementById('projStatus');
                        if (status) {
                            status.innerText = "OFFLINE";
                            status.style.color = "#d32f2f";
                        }
                    }
                }, 1000);
            }
        }
        
        // ============================================
        // FONT MANAGER MODULE
        // ============================================
        class FontManagerModule {
            constructor() {}
            
            init() {
                console.log('Font Manager Module initialized');
                return Promise.resolve();
            }
            
            open() {
                document.getElementById('fontManager').style.display = 'flex';
                document.getElementById('fontStatus').innerText = '';
                this.renderFontList();
            }
            
            fetchGoogleFont() {
                const nameInput = document.getElementById('googleFontName');
                const name = nameInput.value.trim();
                const status = document.getElementById('fontStatus');
                
                if (!name) return;
                
                status.innerText = "Fetching...";
                status.style.color = "#bbb";
                
                const link = document.createElement('link');
                link.href = `https://fonts.googleapis.com/css?family=${name.replace(/ /g, '+')}&display=swap`;
                link.rel = 'stylesheet';
                
                link.onload = () => {
                    this.addFontOption(name);
                    status.innerText = `Success! "${name}" added.`;
                    status.style.color = "#4caf50";
                    nameInput.value = "";
                    this.renderFontList();
                    
                    // Update projector window if open
                    if (OpenWorship.Projector.projectorWindow && !OpenWorship.Projector.projectorWindow.closed) {
                        try {
                            const newLink = OpenWorship.Projector.projectorWindow.document.createElement('link');
                            newLink.href = link.href;
                            newLink.rel = 'stylesheet';
                            OpenWorship.Projector.projectorWindow.document.head.appendChild(newLink);
                        } catch (e) {
                            console.log("Failed to update projector with Google Font:", e);
                        }
                    }
                    
                    setTimeout(() => {
                        document.getElementById('fontManager').style.display = 'none';
                        status.innerText = "";
                    }, 1000);
                };
                
                link.onerror = () => {
                    status.innerText = `Error: Font "${name}" not found.`;
                    status.style.color = "#d32f2f";
                };
                
                document.head.appendChild(link);
            }
            
            uploadLocalFont(input) {
                if (!input.files || !input.files[0]) return;
                
                const status = document.getElementById('fontStatus');
                status.innerText = "Loading file...";
                status.style.color = "#bbb";
                
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const fontName = file.name.split('.')[0];
                    const arrayBuffer = e.target.result;
                    const base64 = this.arrayBufferToBase64(arrayBuffer);
                    const dataURL = `data:font/opentype;base64,${base64}`;
                    
                    // Store font data
                    OpenWorship.Data.localFontData[fontName] = dataURL;
                    
                    const fontFace = new FontFace(fontName, `url(${dataURL})`);
                    fontFace.load().then(loadedFace => {
                        document.fonts.add(loadedFace);
                        this.addFontOption(fontName);
                        status.innerText = `Success! "${fontName}" loaded.`;
                        status.style.color = "#4caf50";
                        input.value = "";
                        this.renderFontList();
                        
                        // Update projector window if open
                        if (OpenWorship.Projector.projectorWindow && !OpenWorship.Projector.projectorWindow.closed) {
                            try {
                                const style = OpenWorship.Projector.projectorWindow.document.createElement('style');
                                style.textContent = `@font-face { font-family: "${fontName}"; src: url(${dataURL}); }`;
                                OpenWorship.Projector.projectorWindow.document.head.appendChild(style);
                            } catch (e) {
                                console.log("Failed to update projector fonts:", e);
                            }
                        }
                        
                        setTimeout(() => {
                            document.getElementById('fontManager').style.display = 'none';
                            status.innerText = "";
                        }, 1000);
                    }).catch(err => {
                        status.innerText = "Failed to load font file.";
                        status.style.color = "#d32f2f";
                    });
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                for (let i = 0; i < bytes.length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }
            
            addFontOption(name) {
                if (!OpenWorship.State.availableFonts.includes(name)) {
                    OpenWorship.State.availableFonts.push(name);
                    
                    const select = document.getElementById('toolFont');
                    if (select) {
                        let exists = false;
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value === name) {
                                exists = true;
                                break;
                            }
                        }
                        
                        if (!exists) {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            select.appendChild(option);
                        }
                    }
                }
            }
            
            renderFontList() {
                const list = document.getElementById('installedFontsList');
                list.innerHTML = '';
                
                OpenWorship.State.availableFonts.forEach(font => {
                    const div = document.createElement('div');
                    div.className = 'font-list-item';
                    div.textContent = font;
                    div.style.fontFamily = font;
                    list.appendChild(div);
                });
            }
        }
        
        // ============================================
        // SCRIPTURE SETTINGS MODULE
        // ============================================
        class ScriptureSettingsModule {
            constructor() {}
            
            init() {
                console.log('Scripture Settings Module initialized');
                return Promise.resolve();
            }
            
            open() {
                const modal = document.getElementById('scriptureSettingsModal');
                modal.style.display = 'flex';
                
                // Populate font select
                const fontSelect = document.getElementById('scriptureFontSelect');
                fontSelect.innerHTML = '';
                
                OpenWorship.State.availableFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    if (font === OpenWorship.State.scriptureSettings.font) {
                        option.selected = true;
                    }
                    fontSelect.appendChild(option);
                });
                
                // Set current values
                document.getElementById('scriptureSizeInput').value = 
                    OpenWorship.State.scriptureSettings.scriptureSize;
                document.getElementById('footerSizeInput').value = 
                    OpenWorship.State.scriptureSettings.footerSize;
                
                // Populate size options
                this.updateSizeOptions();
                
                // Update preview
                this.updatePreview();
                
                // Add event listeners
                fontSelect.addEventListener('change', () => this.updatePreview());
                document.getElementById('scriptureSizeInput').addEventListener('input', () => this.updatePreview());
                document.getElementById('footerSizeInput').addEventListener('input', () => this.updatePreview());
                document.getElementById('testScriptureSelect').addEventListener('change', () => this.updatePreview());
            }
            
            updateSizeOptions() {
                // Scripture size options
                const scriptureSizeOptions = document.getElementById('scriptureSizeOptions');
                scriptureSizeOptions.innerHTML = '';
                
                OpenWorship.State.customFontSizes.scriptureSizes.forEach(size => {
                    const div = document.createElement('div');
                    div.className = `size-option ${size === OpenWorship.State.scriptureSettings.scriptureSize ? 'active' : ''}`;
                    div.textContent = size;
                    div.onclick = () => {
                        OpenWorship.State.scriptureSettings.scriptureSize = size;
                        document.getElementById('scriptureSizeInput').value = size;
                        this.updatePreview();
                        this.updateSizeOptions();
                    };
                    scriptureSizeOptions.appendChild(div);
                });
                
                // Footer size options
                const footerSizeOptions = document.getElementById('footerSizeOptions');
                footerSizeOptions.innerHTML = '';
                
                OpenWorship.State.customFontSizes.footerSizes.forEach(size => {
                    const div = document.createElement('div');
                    div.className = `size-option ${size === OpenWorship.State.scriptureSettings.footerSize ? 'active' : ''}`;
                    div.textContent = size;
                    div.onclick = () => {
                        OpenWorship.State.scriptureSettings.footerSize = size;
                        document.getElementById('footerSizeInput').value = size;
                        this.updatePreview();
                        this.updateSizeOptions();
                    };
                    footerSizeOptions.appendChild(div);
                });
            }
            
            addScriptureSize() {
                const input = document.getElementById('scriptureSizeInput');
                const size = parseInt(input.value);
                
                if (size && size >= 20 && size <= 200) {
                    if (!OpenWorship.State.customFontSizes.scriptureSizes.includes(size)) {
                        OpenWorship.State.customFontSizes.scriptureSizes.push(size);
                        OpenWorship.State.customFontSizes.scriptureSizes.sort((a, b) => a - b);
                        OpenWorship.Data.saveCustomFontSizes();
                        this.updateSizeOptions();
                    }
                    
                    OpenWorship.State.scriptureSettings.scriptureSize = size;
                    this.updatePreview();
                }
            }
            
            addFooterSize() {
                const input = document.getElementById('footerSizeInput');
                const size = parseInt(input.value);
                
                if (size && size >= 20 && size <= 100) {
                    if (!OpenWorship.State.customFontSizes.footerSizes.includes(size)) {
                        OpenWorship.State.customFontSizes.footerSizes.push(size);
                        OpenWorship.State.customFontSizes.footerSizes.sort((a, b) => a - b);
                        OpenWorship.Data.saveCustomFontSizes();
                        this.updateSizeOptions();
                    }
                    
                    OpenWorship.State.scriptureSettings.footerSize = size;
                    this.updatePreview();
                }
            }
            
            updatePreview() {
                // Update settings from inputs
                OpenWorship.State.scriptureSettings.font = 
                    document.getElementById('scriptureFontSelect').value;
                OpenWorship.State.scriptureSettings.scriptureSize = 
                    parseInt(document.getElementById('scriptureSizeInput').value);
                OpenWorship.State.scriptureSettings.footerSize = 
                    parseInt(document.getElementById('footerSizeInput').value);
                
                // Get test scripture
                const testScripture = document.getElementById('testScriptureSelect').value;
                let scriptureText = "";
                let reference = "";
                
                switch (testScripture) {
                    case "John 3:16":
                        scriptureText = "For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life.";
                        reference = "John 3:16";
                        break;
                    case "Psalm 23:1":
                        scriptureText = "The Lord is my shepherd, I lack nothing. He makes me lie down in green pastures, he leads me beside quiet waters.";
                        reference = "Psalm 23:1";
                        break;
                    case "Matthew 28:19":
                        scriptureText = "Go therefore and make disciples of all nations, baptizing them in the name of the Father and of the Son and of the Holy Spirit.";
                        reference = "Matthew 28:19";
                        break;
                    case "Romans 8:28":
                        scriptureText = "And we know that in all things God works for the good of those who love him, who have been called according to his purpose.";
                        reference = "Romans 8:28";
                        break;
                }
                
                // Render preview
                const canvas = document.getElementById('scripturePreviewCanvas');
                const ctx = canvas.getContext('2d');
                
                // Clear
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, OPENWORSHIP_CONFIG.RESOLUTION.width, OPENWORSHIP_CONFIG.RESOLUTION.height);
                
                // Set font
                const fontSize = OpenWorship.State.scriptureSettings.scriptureSize;
                const fontFace = OpenWorship.State.scriptureSettings.font;
                const color = OpenWorship.State.scriptureSettings.color;
                
                ctx.font = `${OpenWorship.State.scriptureSettings.italic ? 'italic' : ''} ${OpenWorship.State.scriptureSettings.bold ? 'bold' : ''} ${fontSize}px "${fontFace}"`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = color;
                
                // Word wrap
                const maxWidth = OPENWORSHIP_CONFIG.RESOLUTION.width - 200;
                const words = scriptureText.split(' ');
                let lines = [];
                let currentLine = words[0];
                
                for (let i = 1; i < words.length; i++) {
                    const testLine = currentLine + ' ' + words[i];
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width < maxWidth) {
                        currentLine = testLine;
                    } else {
                        lines.push(currentLine);
                        currentLine = words[i];
                    }
                }
                lines.push(currentLine);
                
                // Calculate positioning
                const lineHeight = fontSize * 1.2;
                const totalHeight = lines.length * lineHeight;
                const startY = (OPENWORSHIP_CONFIG.RESOLUTION.height - totalHeight) / 2 + (lineHeight / 2);
                
                // Draw text with shadow
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                lines.forEach((line, index) => {
                    const y = startY + (index * lineHeight);
                    ctx.fillText(line, OPENWORSHIP_CONFIG.RESOLUTION.width / 2, y);
                });
                
                // Draw reference footer
                ctx.shadowBlur = 0;
                ctx.font = `bold ${OpenWorship.State.scriptureSettings.footerSize}px Arial`;
                ctx.textAlign = 'right';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText(`- ${reference} (KJV)`,
                    OPENWORSHIP_CONFIG.RESOLUTION.width - 50,
                    OPENWORSHIP_CONFIG.RESOLUTION.height - 50
                );
                
                // Update size options highlight
                this.updateSizeOptions();
            }
            
            reset() {
                OpenWorship.State.scriptureSettings = {
                    font: "Segoe UI",
                    scriptureSize: 90,
                    footerSize: 40,
                    bold: false,
                    italic: false,
                    color: "#ffffff"
                };
                
                document.getElementById('scriptureFontSelect').value = 
                    OpenWorship.State.scriptureSettings.font;
                document.getElementById('scriptureSizeInput').value = 
                    OpenWorship.State.scriptureSettings.scriptureSize;
                document.getElementById('footerSizeInput').value = 
                    OpenWorship.State.scriptureSettings.footerSize;
                
                this.updatePreview();
                OpenWorship.UI.showToast('Scripture settings reset to default');
            }
            
            save() {
                OpenWorship.Data.saveScriptureSettings();
                document.getElementById('scriptureSettingsModal').style.display = 'none';
            }
        }
        
        // ============================================
        // FILE HANDLERS AND UTILITIES
        // ============================================
        // These are kept as global functions for HTML event handlers
        
        function handleLogoUpload(input) {
            OpenWorship.Projector.handleLogoUpload(input);
        }
        
        function handleContentLoad(input) {
            OpenWorship.Data.handleContentLoad(input);
        }
        
        function handleScheduleLoad(input) {
            OpenWorship.Schedule.load(input);
        }
        
        function handlePresentationLoad(input) {
            if (input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        let presentations = [];
                        
                        if (data.presentations && Array.isArray(data.presentations)) {
                            presentations = data.presentations;
                        } else if (Array.isArray(data)) {
                            presentations = data.filter(item => item.type === 'Presentation');
                        } else {
                            OpenWorship.UI.showToast("Invalid presentation file format");
                            return;
                        }
                        
                        if (presentations.length === 0) {
                            OpenWorship.UI.showToast("No presentations found in file");
                            return;
                        }
                        
                        // Remove existing presentations
                        OpenWorship.State.library = OpenWorship.State.library.filter(item => 
                            item.type !== 'Presentation'
                        );
                        
                        // Add imported presentations
                        presentations.forEach(pres => {
                            const newPres = JSON.parse(JSON.stringify(pres));
                            newPres.id = Date.now() + Math.random();
                            OpenWorship.State.library.push(newPres);
                        });
                        
                        // Save to localStorage
                        OpenWorship.Data.savePresentationsToStorage();
                        
                        // Refresh library view
                        if (OpenWorship.State.currentTab === 'Presentation') {
                            OpenWorship.Library.render();
                        }
                        
                        OpenWorship.UI.showToast(`Imported ${presentations.length} presentations!`);
                        input.value = '';
                        
                    } catch (err) {
                        OpenWorship.UI.showToast("Error reading presentation file: " + err.message);
                    }
                };
                
                reader.readAsText(file);
            }
        }
        
        function handleExtensionLoad(input) {
            if (input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const extension = OpenWorship.Extensions.parseExtension(file.name, e.target.result);
                        if (extension) {
                            OpenWorship.Extensions.register(extension);
                            if (extension.init && typeof extension.init === 'function') {
                                extension.init(OpenWorship);
                                extension.initialized = true;
                                OpenWorship.Extensions.loaded.push(extension);
                                OpenWorship.Extensions.trigger('extension:loaded', extension);
                                OpenWorship.UI.showToast(`Extension "${extension.name}" loaded!`);
                            }
                        }
                    } catch (err) {
                        OpenWorship.UI.showToast("Error loading extension: " + err.message);
                    }
                };
                
                reader.readAsText(file);
            }
        }
        
        function handleFolderLoad(input) {
            if (input.files.length > 0) {
                OpenWorship.Extensions.loadExtensionsFromFolder(Array.from(input.files))
                    .then(extensions => {
                        OpenWorship.UI.showToast(`Loaded ${extensions.length} extensions from folder!`);
                        input.value = '';
                    })
                    .catch(error => {
                        OpenWorship.UI.showToast("Error loading folder: " + error.message);
                    });
            }
        }
        
        function downloadBibleFromWeb() {
            const statusLabel = document.getElementById('projStatus');
            statusLabel.innerText = "FETCHING BIBLE...";
            statusLabel.style.color = "orange";
            
            fetch('https://raw.githubusercontent.com/thiagobodruk/bible/master/json/en_kjv.json')
                .then(response => response.json())
                .then(data => {
                    const newBibleLibrary = [];
                    let idCounter = 10000;
                    
                    if (Array.isArray(data) && data[0].chapters) {
                        data.forEach(book => {
                            book.chapters.forEach((chapter, cIdx) => {
                                chapter.forEach((verse, vIdx) => {
                                    newBibleLibrary.push({
                                        id: idCounter++,
                                        title: `${book.name} ${cIdx + 1}:${vIdx + 1}`,
                                        type: "Scripture",
                                        slides: [{ layers: [{ text: verse, style: { fontSize: 90 } }] }]
                                    });
                                });
                            });
                        });
                        
                        statusLabel.innerText = "OFFLINE";
                        statusLabel.style.color = "#d32f2f";
                        
                        processFetchedData(newBibleLibrary, 'OpenWorship_KJV', 'bible', 'Bible');
                    } else {
                        throw new Error("Invalid format");
                    }
                })
                .catch(error => {
                    OpenWorship.UI.showToast("Download Failed: " + error.message);
                });
        }
        
        function downloadHymnsFromWeb() {
            const statusLabel = document.getElementById('projStatus');
            statusLabel.innerText = "FETCHING HYMNS...";
            statusLabel.style.color = "orange";
            
            // Mock hymns data
            const hymns = [
                {
                    title: "Amazing Grace",
                    verses: ["Amazing Grace! how sweet the sound, That saved a wretch like me! I once was lost, but now am found, Was blind, but now I see."],
                    chorus: ["Amazing Grace, amazing love, Reaching from heaven above."]
                },
                {
                    title: "Holy, Holy, Holy",
                    verses: ["Holy, holy, holy! Lord God Almighty! Early in the morning our song shall rise to Thee; Holy, holy, holy, merciful and mighty! God in three Persons, blessed Trinity!"],
                    chorus: [""]
                }
            ];
            
            const formattedHymns = [];
            let idCounter = 20000;
            
            hymns.forEach(hymn => {
                const slides = [];
                hymn.verses.forEach(verse => {
                    slides.push({
                        layers: [{ text: verse.replace(/, /g, ',\n'), style: { fontSize: 80 } }]
                    });
                });
                
                if (hymn.chorus[0] && hymn.chorus[0] !== "") {
                    slides.unshift({
                        layers: [{
                            text: hymn.chorus.join('\n').replace(/, /g, ',\n'),
                            style: { fontSize: 85, color: "#FFFF00" }
                        }]
                    });
                }
                
                formattedHymns.push({
                    id: idCounter++,
                    title: hymn.title,
                    type: "Song",
                    slides: slides
                });
            });
            
            statusLabel.innerText = "OFFLINE";
            statusLabel.style.color = "#d32f2f";
            
            processFetchedData(formattedHymns, 'OpenWorship_HymnPack', 'hymn', 'Hymns');
        }
        
        function processFetchedData(data, fileName, extension, type) {
            const temp = JSON.stringify(data);
            const msgBox = document.getElementById('saveAlertModal').querySelector('h3');
            
            msgBox.innerText = `${type} Fetched!`;
            document.getElementById('saveMsg').innerHTML = 
                `Successfully fetched ${data.length} ${type.toLowerCase()} items. Please save this <strong>.${extension}</strong> file to your computer.`;
            
            document.getElementById('saveAlertModal').style.display = 'flex';
            
            const saveBtn = document.getElementById('btnSaveDisk');
            const newBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newBtn, saveBtn);
            newBtn.innerText = `Save .${extension} File`;
            
            newBtn.onclick = () => {
                const blob = new Blob([temp], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName + '.' + extension;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.getElementById('saveAlertModal').style.display = 'none';
                OpenWorship.UI.showToast(`Saved ${type} to disk.`);
            };
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        async function initOpenWorship() {
            // Initialize core
            OpenWorship.Core = new CoreModule();
            await OpenWorship.Core.init();
            
            // Render initial views
            OpenWorship.Schedule.render();
            OpenWorship.Library.switchTab('Song');
            
            // Initial render of preview and monitor
            const monitorCtx = document.getElementById('monitorCanvas').getContext('2d');
            const previewCtx = document.getElementById('libraryPreviewCanvas').getContext('2d');
            
            OpenWorship.Projector.renderSlide(monitorCtx, null);
            OpenWorship.Projector.renderSlide(previewCtx, {
                layers: [{ text: "Select Item", style: { fontSize: 60 } }]
            });
            
            console.log('OpenWorship fully initialized');
            
            // Example: Register a sample extension
            OpenWorship.Extensions.register({
                id: 'sample_clock',
                name: 'Live Clock',
                version: '1.0.0',
                author: 'OpenWorship Team',
                init: function(OW) {
                    console.log('Clock extension initialized');
                    
                    // Add clock to menu
                    OW.Extensions.addExtensionMenuItem('Show Clock', () => {
                        alert('Clock would show here');
                    });
                    
                    // Add a hook to update clock on live display
                    OW.Extensions.addHook('projector:open', () => {
                        console.log('Clock extension: Projector opened');
                    });
                }
            });
        }
        
        // Start initialization when page loads
        window.addEventListener('DOMContentLoaded', initOpenWorship);
    </script>
    
    <!-- PRE-LOAD FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* CORE VARIABLES */
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-header: #2d2d2d;
            --accent: #007acc;
            --text-main: #e0e0e0;
            --border: #333;
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- UI COMPONENTS --- */
        .menu-bar {
            height: 28px; background: #1a1a1a; display: flex; align-items: center; 
            padding: 0 12px; font-size: 0.8rem; border-bottom: 1px solid #333; gap: 5px; user-select: none;
        }
        .menu-item { padding: 4px 10px; cursor: default; color: #bbb; position: relative; border-radius: 4px; }
        .menu-item:hover, .menu-item.active { background: #333; color: white; }
        .dropdown { display: none; position: absolute; top: 100%; left: 0; background: #2a2a2a; border: 1px solid #444; min-width: 200px; z-index: 500; box-shadow: 0 4px 10px rgba(0,0,0,0.5); padding: 4px 0; border-radius: 4px; }
        .menu-item.active .dropdown { display: block; }
        .dropdown div { padding: 6px 20px; color: #ddd; }
        .dropdown div:hover { background: var(--accent); }
        .separator { height:1px; background:#444; margin:4px 0; }

        /* HEADER */
        header {
            min-height: 50px; height: auto;
            background: var(--bg-header); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 5px 16px; justify-content: space-between; gap: 20px;
            flex-wrap: wrap; 
        }
        .brand { font-weight: bold; font-size: 1.1rem; color: #f0f0f0; display:flex; align-items:center; gap:10px; white-space: nowrap; flex-shrink: 0; }
        .brand-badge { font-size: 0.65em; background: #151515; padding: 3px 10px; border-radius: 25px; border: 1px solid #333; }
        
        .controls { 
            display: flex; gap: 10px; align-items: center; 
            flex-wrap: wrap; justify-content: flex-end; flex: 1;
        }

        button {
            background: linear-gradient(to bottom, #3a3a3a, #2b2b2b); border: 1px solid #444; color: #f0f0f0;
            padding: 0 16px; border-radius: 6px; cursor: pointer; height: 24px; font-weight:600; font-size:0.8rem;
            white-space: nowrap;
        }
        button:hover { background: #444; border-color: #666; }
        button.live-btn { background: linear-gradient(to bottom, #d32f2f, #b71c1c); border-color: #b71c1c; }
        button.live-btn:hover { background: #f44336; }
        button.active-state { background: var(--accent); border-color: #005f9e; }
        
        /* Specific styling for fullscreen button on the menu bar */
        .btn-toggle-fullscreen {
            padding: 0 8.5px;
            font-size: 0.85rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 27px;
            margin-left: 5px;
        }

        /* --- LAYOUT --- */
        .app-body { display: flex; flex-direction: column; flex: 1; height: calc(100vh - 78px); }
        .top-section { display: flex; flex: 1; min-height: 0; }
        
        .panel { display:flex; flex-direction:column; }
        .panel-left { width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border); resize: horizontal; overflow:auto; }
        .panel-center { flex: 1; background: #111; padding: 20px; overflow-y: auto; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 15px; justify-content: center; }
        .panel-right { width: 300px; background: black; border-left: 1px solid var(--border); padding: 15px; align-items: center; }
        
        .panel-header { padding: 8px 12px; background: linear-gradient(to right, #252525, #222); font-size: 0.75rem; font-weight: bold; color: #888; border-bottom: 1px solid var(--border); text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* SCHEDULE & LIBRARY */
        .schedule-container { flex: 1; overflow-y: auto; min-height: 50px; }
        .schedule-container.drag-over { background: rgba(0, 122, 204, 0.1); }
        
        .schedule-item { 
            padding: 10px 12px; 
            border-bottom: 1px solid #2a2a2a; 
            cursor: default; 
            display: flex; 
            font-size: 0.9rem; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .schedule-item:hover { background: #333; }
        .schedule-item.selected { background: var(--accent); color: white; border-left: 3px solid #66b2ff; }
        .schedule-item.dragging { opacity: 0.5; background: #444; border: 1px dashed #666; }

        .bottom-section { height: 300px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; flex-direction: column; }
        .library-tabs { display: flex; background: #252525; border-bottom: 1px solid var(--border); align-items: center; }
        .tab { padding: 8px 20px; cursor: pointer; color: #888; border-right: 1px solid #333; }
        .tab.active { background: var(--bg-panel); color: var(--accent); font-weight: bold; border-bottom: 2px solid var(--accent); }
        
        .library-content { 
            flex: 1; 
            display: flex; 
            position: relative; 
            overflow: hidden;
        } 
        
        .library-list-container {
            flex: 1;
            display: none;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        
        .library-list-container.active {
            display: flex;
        }
        
        .library-list {
            flex: 1;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            position: relative;
        }
        
        /* FLOATING ADD BUTTON */
        .fab-add {
            position: absolute; bottom: 20px; right: 420px;
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: var(--accent); color: white; font-size: 24px; font-weight: bold;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; z-index: 100;
            transition: transform 0.2s, background 0.2s;
        }
        .fab-add:hover { transform: scale(1.1); background: #005f9e; }

        .preview-pane-wrapper { width: 400px; display: flex; flex-direction: column; border-left: 1px solid #222; background: #1a1a1a; }
        
        /* LIBRARY PREVIEW CONTAINERS */
        .library-preview-container {
            flex: 1;
            background: #181818;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }
        
        /* CANVAS (Visual Preview) */
        canvas.library-preview-canvas {
            width: 100%;
            aspect-ratio: 16/9;
            background: black;
            border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        /* TEXT AREA (Scripture Preview) */
        #libraryPreviewText {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            background: #181818;
            color: #ddd;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
        }
        
        /* PREVIEW CARDS */
        .slide-wrapper { transition: transform 0.1s; cursor: pointer; }
        .slide-wrapper:hover { transform: scale(1.03); }
        .slide-wrapper.active canvas { border-color: #d32f2f; box-shadow: 0 0 20px rgba(211,47,47,0.6); }
        canvas.preview-canvas { background: black; border: 2px solid #333; border-radius: 4px; width: 200px; aspect-ratio: 16/9; object-fit: contain; }
        canvas.live-monitor { 
            width: 100%; aspect-ratio: 16/9; border: 2px solid #444; background: black; border-radius: 4px;
            transition: opacity 0.3s ease;
        }
        canvas.live-monitor.fading { opacity: 0; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .editor-window { width: 90vw; height: 90vh; background: #222; border: 1px solid #444; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .editor-header { padding: 10px 15px; background: #333; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .editor-body { display: flex; flex: 1; overflow: hidden; }
        .editor-sidebar { width: 200px; background: #1a1a1a; border-right: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; }
        .slide-thumb { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; opacity: 0.7; display:flex; gap:10px; align-items:center; }
        .slide-thumb:hover { opacity: 1; background: #252525; }
        .slide-thumb.active { opacity: 1; background: var(--accent); color: white; }
        .thumb-num { font-weight: bold; font-size: 1.2rem; opacity: 0.5; }
        .editor-main { flex: 1; display: flex; flex-direction: column; background: #151515; }
        .editor-preview-area { flex: 1; display: flex; align-items: center; justify-content: center; background: #111; padding: 20px; overflow: hidden; position: relative; }
        .editor-canvas { width: 70%; aspect-ratio: 16/9; background: black; border: 1px solid #555; box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: default; }
        .editor-toolbar { padding: 8px; background: #252525; border-top: 1px solid #444; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .tool-group { display: flex; gap: 5px; border-right: 1px solid #444; padding-right: 10px; align-items: center; }
        .tool-input { background: #111; border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; }
        .tool-btn { width: 30px; padding: 0; }
        .tool-label { font-size: 0.7rem; color: #888; margin-right: 5px; }
        .editor-text-input { height: 120px; background: #222; padding: 0 10px 10px 10px; display: flex; flex-direction: column; }
        .editor-textarea { flex: 1; background: #111; border: 1px solid #333; color: white; resize: none; padding: 10px; font-family: inherit; outline: none; }
        .editor-textarea:focus { border-color: var(--accent); }

        /* FONT MANAGER MODAL */
        .font-modal-content { width: 400px; background: #222; border: 1px solid #444; padding: 20px; border-radius: 8px; }
        .font-input-group { margin-bottom: 15px; }
        .font-input-group label { display: block; color: #888; margin-bottom: 5px; font-size: 0.9rem; }
        .font-input-group input { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; border-radius: 4px; }
        #fontStatus { height: 20px; margin-bottom: 10px; font-size: 0.9rem; font-weight = bold; }
        .font-list-container {
            max-height: 150px; overflow-y: auto; background: #111; border: 1px solid #444; border-radius: 4px; margin-bottom: 15px;
        }
        .font-list-item {
            padding: 8px 10px; border-bottom: 1px solid #2a2a2a; color: #eee; font-size: 1.1rem; cursor: default;
        }
        .font-list-item:last-child { border-bottom: none; }

        /* SCRIPTURE SETTINGS MODAL */
        .scripture-modal-content {
            width: 800px;
            background: #222;
            border: 1px solid #444;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .scripture-preview-container {
            display: flex;
            gap: 20px;
        }
        
        .scripture-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .scripture-preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-row input[type="number"] {
            width: 80px;
            padding: 6px;
            background: #111;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }
        
        .control-row select {
            flex: 1;
            padding: 6px;
            background: #111;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }
        
        .control-row button {
            padding: 6px 12px;
            height: auto;
        }
        
        .size-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .size-option {
            padding: 4px 8px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .size-option:hover {
            background: #444;
        }
        
        .size-option.active {
            background: var(--accent);
            border-color: #005f9e;
        }
        
        canvas.scripture-preview-canvas {
            width: 100%;
            aspect-ratio: 16/9;
            background: black;
            border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* RANGE ITEM */
        .range-item { background: #0d2b3e; border-left: 3px solid #007acc; color: #fff; font-weight: bold; }
        .range-item:hover { background: #163d55; }

        /* TOAST NOTIFICATION */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid #555;
        }
        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        
        /* Update Banner Style */
        #updateBanner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #252525;
            border-left: 5px solid #00C4FF;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            z-index: 3000;
            font-family: 'Segoe UI', sans-serif;
            min-width: 350px;
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        #updateBanner h4 { margin: 0 0 5px 0; color: #00C4FF; font-size: 1.1rem; }
        #updateBanner p { margin: 0 0 15px 0; font-size: 0.9rem; color: #ddd; }
        .update-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }
        .update-btn:hover { background: #005f9e; }
        .close-update {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
        }
        .close-update:hover { color: white; }

        /* SAVE PRESENTATION DIALOG */
        .save-dialog {
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            min-width: 400px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        
        .save-dialog h3 {
            margin-top: 0;
            color: #eee;
        }
        
        .save-dialog p {
            color: #ccc;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes slideUp { from {bottom: -100px; opacity: 0;} to {bottom: 20px; opacity: 1;} }
    </style>
</head>
<body>

    <!-- MENU BAR -->
    <div class="menu-bar" id="menuBar">
        <div class="menu-item" data-menu="file">File
            <div class="dropdown">
                <div onclick="document.getElementById('logoInput').click()">Upload Logo...</div>
                <div class="separator"></div>
                <div onclick="downloadBibleFromWeb()">Fetch Bible (Web)</div>
                <div onclick="downloadHymnsFromWeb()">Fetch Hymns (Web)</div>
                <div onclick="document.getElementById('contentInput').click()">Load Content (Disk)</div>
                <div class="separator"></div>
                <div onclick="OpenWorship.Schedule.save()">Save Schedule...</div>
                <div onclick="document.getElementById('scheduleInput').click()">Open Schedule...</div>
                <div class="separator"></div>
                <div onclick="exportPresentations()">Export Presentations (.presentation)...</div>
                <div onclick="document.getElementById('presentationInput').click()">Import Presentations (.presentation)...</div>
                <div class="separator"></div>
                <div onclick="location.reload()">Exit</div>
            </div>
        </div>
        <div class="menu-item" data-menu="edit">Edit
            <div class="dropdown">
                <div>Undo</div>
                <div>Redo</div>
            </div>
        </div>
        <div class="menu-item" data-menu="fonts">Fonts
            <div class="dropdown">
                <div onclick="OpenWorship.FontManager.open()">Manage Fonts...</div>
            </div>
        </div>
        <div class="menu-item" data-menu="window">Window
            <div class="dropdown">
                <div onclick="OpenWorship.Projector.openProjector()">Open Projector</div>
                <div class="separator"></div>
                <div onclick="OpenWorship.ScriptureSettings.open()">Scripture Display Settings</div>
            </div>
        </div>
        <div class="menu-item" data-menu="extensions">Extensions
            <div class="dropdown">
                <div>No extensions loaded</div>
                <div class="separator"></div>
                <div onclick="document.getElementById('extensionInput').click()">Load Extension...</div>
                <div onclick="document.getElementById('folderInput').click()">Load Folder...</div>
            </div>
        </div>
        <div style="margin-left:auto; color:#666; font-weight:bold;"><span id="version-display">v3.2.0</span></div>
        <button id="btnFullscreen" class="btn-toggle-fullscreen" title="Toggle Fullscreen Mode">
             &#x26F6;
        </button>
    </div>

    <!-- HEADER -->
    <header>
        <div class="brand">OpenWorship <span class="brand-badge">MODULAR v3.2.0</span></div>
        <div class="controls">
            <button id="btnBlack" onclick="OpenWorship.Projector.toggleBlack()">Black</button>
            <button id="btnClear" onclick="OpenWorship.Projector.toggleClear()">Clear</button>
            <button id="btnLogo" onclick="OpenWorship.Projector.toggleLogo()">Logo</button>
            <div style="width:1px; height:20px; background:#444;"></div>
            <button class="live-btn" onclick="OpenWorship.Projector.openProjector()">GO LIVE</button>
        </div>
    </header>

    <!-- MAIN BODY -->
    <div class="app-body">
        <div class="top-section">
            <div class="panel panel-left">
                <div class="panel-header">SCHEDULE</div>
                <!-- DROP ZONE SCHEDULE -->
                <div class="schedule-container" id="scheduleList" 
                     ondragover="event.preventDefault()" 
                     ondrop="OpenWorship.Schedule.drop(event, OpenWorship.State.schedule.length)">
                </div>
            </div>
            <div class="panel panel-center" id="slideGrid">
                <div style="color:#444; margin-top:50px;">Select an item to preview</div>
            </div>
            <div class="panel panel-right">
                <div class="panel-header" style="background:none;">LIVE OUTPUT</div>
                <canvas id="monitorCanvas" class="live-monitor" width="1920" height="1080"></canvas>
                <div style="margin-top:5px; color:#666; font-size:0.8rem;">Status: <span id="projStatus">OFFLINE</span></div>
            </div>
        </div>
        <div class="bottom-section">
            <div class="library-tabs">
                <div class="tab active" onclick="OpenWorship.Library.switchTab('Song')">Songs</div>
                <div class="tab" onclick="OpenWorship.Library.switchTab('Scripture')">Scriptures</div>
                <div class="tab" onclick="OpenWorship.Library.switchTab('Presentation')">Presentations</div>
                <div style="flex:1;"></div>
                <input type="text" id="librarySearch" placeholder="Search Library..." style="background:#111; border:1px solid #333; color:white; padding:5px 12px; width:250px; outline:none; border-radius:15px; margin-right:10px;" oninput="OpenWorship.Library.handleSearch()">
            </div>
            <div class="library-content">
                <!-- Separate containers for each tab -->
                <div class="library-list-container active" id="songListContainer">
                    <div class="library-list" id="libraryListSong"
                         ondragover="event.preventDefault()" 
                         ondrop="OpenWorship.Library.dropOnLibrary(event)">
                    </div>
                </div>
                
                <div class="library-list-container" id="scriptureListContainer">
                    <div class="library-list" id="libraryListScripture"
                         ondragover="event.preventDefault()" 
                         ondrop="OpenWorship.Library.dropOnLibrary(event)">
                    </div>
                </div>
                
                <div class="library-list-container" id="presentationListContainer">
                    <div class="library-list" id="libraryListPresentation"
                         ondragover="event.preventDefault()" 
                         ondrop="OpenWorship.Library.dropOnLibrary(event)">
                    </div>
                </div>
                
                <!-- FLOATING ADD BUTTON (Visible on Presentation Tab) -->
                <button class="fab-add" id="addPresBtn" onclick="OpenWorship.Editor.createNewPresentation()" title="Create New Presentation">+</button>

                <div class="preview-pane-wrapper">
                    <div class="panel-header">PREVIEW</div>
                    <!-- PREVIEW CONTAINER: CONDITIONAL CONTENT -->
                    <div class="library-preview-container">
                        <!-- 1. CANVAS FOR VISUAL PREVIEW (Songs/Presentations) -->
                        <canvas id="libraryPreviewCanvas" class="library-preview-canvas" width="1920" height="1080"></canvas>
                        
                        <!-- 2. TEXT DIV FOR RAW TEXT PREVIEW (Scriptures) -->
                        <div id="libraryPreviewText" style="display: none;">Select an item to preview text...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DATALIST FOR BIBLE BOOKS -->
    <datalist id="bibleBooks">
        <option value="Genesis"><option value="Exodus"><option value="Leviticus"><option value="Numbers"><option value="Deuteronomy">
        <option value="Joshua"><option value="Judges"><option value="Ruth"><option value="1 Samuel"><option value="2 Samuel">
        <option value="1 Kings"><option value="2 Kings"><option value="1 Chronicles"><option value="2 Chronicles"><option value="Ezra">
        <option value="Nehemiah"><option value="Esther"><option value="Job"><option value="Psalms"><option value="Proverbs">
        <option value="Ecclesiastes"><option value="Song of Solomon"><option value="Isaiah"><option value="Jeremiah"><option value="Lamentations">
        <option value="Ezekiel"><option value="Daniel"><option value="Hosea"><option value="Joel"><option value="Amos">
        <option value="Obadiah"><option value="Jonah"><option value="Micah"><option value="Nahum"><option value="Habakkuk">
        <option value="Zephaniah"><option value="Haggai"><option value="Zechariah"><option value="Malachi">
        <option value="Matthew"><option value="Mark"><option value="Luke"><option value="John"><option value="Acts">
        <option value="Romans"><option value="1 Corinthians"><option value="2 Corinthians"><option value="Galatians"><option value="Ephesians">
        <option value="Philippians"><option value="Colossians"><option value="1 Thessalonians"><option value="2 Thessalonians"><option value="1 Timothy">
        <option value="2 Timothy"><option value="Titus"><option value="Philemon"><option value="Hebrews"><option value="James">
        <option value="1 Peter"><option value="2 Peter"><option value="1 John"><option value="2 John"><option value="3 John">
        <option value="Jude"><option value="Revelation">
    </datalist>

    <!-- TOAST -->
    <div id="toast">Notification</div>
    
    <!-- UPDATE BANNER -->
    <div id="updateBanner">
        <button class="close-update" onclick="document.getElementById('updateBanner').style.display='none'">&times;</button>
        <h4>New Version Available!</h4>
        <p>A newer version of OpenWorship is ready.</p>
        <a href="https://cleo876.github.io/open-worship/" target="_blank" class="update-btn">Download Update</a>
    </div>

    <!-- MODALS & HIDDEN -->
    <div class="modal-overlay" id="editorModal">
        <div class="editor-window">
            <div class="editor-header" style="display:flex; justify-content:space-between; align-items:center;">
                <input type="text" id="editItemTitle" style="padding: 5px; background: #111; color: white; border: 1px solid #444; border-radius: 4px; font-size: 1.1rem; width: 400px; margin-right: 20px;" placeholder="Presentation Title">
                <div><button onclick="OpenWorship.Editor.close()">Cancel</button><button class="live-btn" onclick="OpenWorship.Editor.saveChanges()">Save Changes</button></div>
            </div>
            <div class="editor-body">
                <div class="editor-sidebar"><div style="padding:10px; background:#222; text-align:center;"><button onclick="OpenWorship.Editor.addNewSlide()" style="width:100%; font-size:0.8rem;">+ Add Slide</button></div><div id="editorSlideList"></div></div>
                <div class="editor-main">
                    <div class="editor-preview-area"><canvas id="editorCanvas" class="editor-canvas" width="1920" height="1080"></canvas></div>
                    <div class="editor-toolbar">
                        <div class="tool-group"><span class="tool-label">Element:</span><button onclick="OpenWorship.Editor.addTextBlock()">+ Text Block</button></div>
                        <div class="tool-group"><span class="tool-label">Font</span><select id="toolFont" class="tool-input" onchange="OpenWorship.Editor.updateCurrentBlockStyle()"></select><input type="number" id="toolSize" class="tool-input" style="width:60px;" value="90" onchange="OpenWorship.Editor.updateCurrentBlockStyle()" list="sizePresets"><datalist id="sizePresets"></datalist></div>
                        <div class="tool-group"><button class="tool-btn" onclick="OpenWorship.Editor.toggleStyle('bold')" style="font-weight:bold;">B</button><button class="tool-btn" onclick="OpenWorship.Editor.toggleStyle('italic')" style="font-style:italic;">I</button><input type="color" id="toolColor" class="tool-input" style="width:40px; height:28px; padding:0;" onchange="OpenWorship.Editor.updateCurrentBlockStyle()"></div>
                        <div class="tool-group"><button onclick="document.getElementById('bgUpload').click()">BG Image</button><input type="file" id="bgUpload" style="display:none;" accept="image/*" onchange="OpenWorship.Editor.uploadSlideBG(this)"><button onclick="OpenWorship.Editor.clearSlideBG()">No BG</button></div>
                        <button onclick="OpenWorship.Editor.removeCurrentBlock()" style="color:#d32f2f; margin-left:auto;">Delete Block</button>
                    </div>
                    <div class="editor-text-input"><textarea id="editorTextArea" class="editor-textarea" placeholder="Select a text block to edit..." oninput="OpenWorship.Editor.updateCurrentBlockText()"></textarea></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="fontManager">
        <div class="font-modal-content">
            <h3 style="margin-top:0; color:#eee;">Manage Fonts</h3>
            <div id="fontStatus"></div>
            <div class="font-input-group"><label>Add from Google Fonts</label><div style="display:flex; gap:5px;"><input type="text" id="googleFontName" placeholder="Font Name"><button onclick="OpenWorship.FontManager.fetchGoogleFont()">Fetch</button></div><a href="https://fonts.google.com" target="_blank" style="font-size:0.8rem; color:#007acc; text-decoration:none; display:block; margin-top:5px;">Browse Google Fonts</a></div>
            <div class="separator"></div>
            <div class="font-input-group"><label>Upload Local Font</label><div style="display:flex; gap:5px;"><button onclick="document.getElementById('localFontInput').click()" style="width:100%;">Select File</button><input type="file" id="localFontInput" accept=".ttf,.otf" style="display:none" onchange="OpenWorship.FontManager.uploadLocalFont(this)"></div></div>
            <div class="separator"></div>
            <label style="display:block; color:#888; margin-bottom:5px; font-size:0.9rem;">Installed Fonts</label>
            <div id="installedFontsList" class="font-list-container"></div>
            <div style="text-align:right; margin-top:20px;"><button onclick="document.getElementById('fontManager').style.display='none'">Close</button></div>
        </div>
    </div>

    <!-- SCRIPTURE SETTINGS MODAL -->
    <div class="modal-overlay" id="scriptureSettingsModal">
        <div class="scripture-modal-content">
            <h3 style="margin-top:0; color:#eee;">Scripture Display Settings</h3>
            <div class="scripture-preview-container">
                <div class="scripture-controls">
                    <div class="control-group">
                        <label>Scripture Text Font</label>
                        <div class="control-row">
                            <select id="scriptureFontSelect"></select>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Scripture Text Size</label>
                        <div class="control-row">
                            <input type="number" id="scriptureSizeInput" min="20" max="200" value="90">
                            <button onclick="OpenWorship.ScriptureSettings.addScriptureSize()">Add Size</button>
                        </div>
                        <div class="size-options" id="scriptureSizeOptions"></div>
                    </div>
                    
                    <div class="control-group">
                        <label>Reference Footer Size</label>
                        <div class="control-row">
                            <input type="number" id="footerSizeInput" min="20" max="100" value="40">
                            <button onclick="OpenWorship.ScriptureSettings.addFooterSize()">Add Size</button>
                        </div>
                        <div class="size-options" id="footerSizeOptions"></div>
                    </div>
                    
                    <div class="control-group">
                        <label>Test Scripture</label>
                        <div class="control-row">
                            <select id="testScriptureSelect">
                                <option value="John 3:16">John 3:16 - For God so loved...</option>
                                <option value="Psalm 23:1">Psalm 23:1 - The Lord is my shepherd...</option>
                                <option value="Matthew 28:19">Matthew 28:19 - Go therefore and make disciples...</option>
                                <option value="Romans 8:28">Romans 8:28 - And we know that all things...</option>
                            </select>
                            <button onclick="OpenWorship.ScriptureSettings.updatePreview()">Update Preview</button>
                        </div>
                    </div>
                </div>
                
                <div class="scripture-preview">
                    <canvas id="scripturePreviewCanvas" class="scripture-preview-canvas" width="1920" height="1080"></canvas>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="OpenWorship.ScriptureSettings.reset()">Reset to Default</button>
                <button onclick="document.getElementById('scriptureSettingsModal').style.display='none'">Cancel</button>
                <button class="live-btn" onclick="OpenWorship.ScriptureSettings.save()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- SAVE ALERT MODAL -->
    <div class="modal-overlay" id="saveAlertModal">
        <div class="modal">
            <h3>Content Fetched!</h3>
            <p id="saveMsg" style="color:#ccc; font-size:0.9rem; line-height:1.5;"></p>
            <div class="modal-buttons"><button onclick="document.getElementById('saveAlertModal').style.display='none'">Close</button><button class="live-btn" id="btnSaveDisk">Save File</button></div>
        </div>
    </div>

    <!-- SAVE PRESENTATION DIALOG -->
    <div class="modal-overlay" id="savePresentationDialog">
        <div class="save-dialog">
            <h3>Save Presentations?</h3>
            <p>You have created or modified presentations. Would you like to save them to your computer before exiting?</p>
            <p style="color: #ff9800; font-size: 0.9rem;"><strong>Note:</strong> Presentations are automatically saved in your browser's storage, but exporting to a file ensures you can restore them on any computer.</p>
            <div class="dialog-buttons">
                <button onclick="document.getElementById('savePresentationDialog').style.display='none'">Don't Save</button>
                <button onclick="exportPresentations()" class="live-btn">Save Presentations</button>
                <button onclick="OpenWorship.Data.savePresentationsToStorage(); document.getElementById('savePresentationDialog').style.display='none'">Just Save to Browser</button>
            </div>
        </div>
    </div>

    <!-- HIDDEN INPUTS -->
    <input type="file" id="logoInput" style="display:none" accept="image/*" onchange="handleLogoUpload(this)">
    <input type="file" id="contentInput" accept=".json,.bible,.hymn" style="display:none" onchange="handleContentLoad(this)">
    <input type="file" id="scheduleInput" style="display:none" accept=".schedule,.json" onchange="handleScheduleLoad(this)">
    <input type="file" id="presentationInput" style="display:none" accept=".presentation,.json" onchange="handlePresentationLoad(this)">
    <input type="file" id="extensionInput" style="display:none" accept=".js,.owx" onchange="handleExtensionLoad(this)">
    <input type="file" id="folderInput" style="display:none" webkitdirectory mozdirectory directory multiple onchange="handleFolderLoad(this)">
    
    <!-- CONTEXT MENU -->
    <div id="contextMenu" class="dropdown" style="position:absolute; display:none;">
        <div id="ctxEdit" onclick="OpenWorship.Library.rightClickedItem && OpenWorship.Editor.open(OpenWorship.Library.rightClickedItem.index, OpenWorship.Library.rightClickedItem.context)">Edit Item</div>
        <div id="ctxRename">Rename Item</div>
        <div id="ctxRemove" onclick="OpenWorship.Library.removeItem()">Remove</div>
    </div>

    <script>
        // Initialize sample data
        OpenWorship.State.library = [
            { id: 1, title: "Way Maker", type: "Song", slides: [ {layers:[{text:"You are here\nMoving in our midst", style:{fontSize:90}}]}, {layers:[{text:"Way maker, miracle worker", style:{fontSize:90}}]} ] },
            { id: 2, title: "10,000 Reasons", type: "Song", slides: [ {layers:[{text:"Bless the Lord O my soul", style:{fontSize:90}}]} ] }
        ];
        
        OpenWorship.State.schedule = JSON.parse(JSON.stringify(OpenWorship.State.library));
        
        // Export presentations function (updated to use .presentation extension)
        function exportPresentations() {
            const presentations = OpenWorship.State.library.filter(item => item.type === 'Presentation');
            if (presentations.length === 0) {
                OpenWorship.UI.showToast("No presentations to export!");
                return;
            }
            
            document.body.style.cursor = 'wait';
            
            const exportData = {
                version: OPENWORSHIP_CONFIG.VERSION,
                exportDate: new Date().toISOString(),
                type: 'OpenWorship Presentations',
                presentations: presentations
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `OpenWorship_Presentations_${new Date().toISOString().slice(0,10)}.presentation`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.body.style.cursor = 'default';
            OpenWorship.UI.showToast(`Exported ${presentations.length} presentations!`);
            document.getElementById('savePresentationDialog').style.display = 'none';
            OpenWorship.Data.savePresentationsToStorage();
        }
    </script>
</body>
</html>
